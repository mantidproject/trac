<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  


  <head>
    <title>
      #7583 (Crash with quick script that changes log values or instrument parameters)
     – Mantid Project
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
        <link rel="search" href="../search.html" />
        <link rel="prev" href="7582.html" title="Ticket #7582" />
        <link rel="last" href="11888.html" title="Ticket #11888" />
        <link rel="help" href="../wiki/TracGuide.html" />
        <link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/7583?format=csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/7583?format=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/7583?format=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="next" href="7584.html" title="Ticket #7584" />
        <link rel="start" href="../wiki.html" />
        <link rel="stylesheet" href="../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../chrome/common/css/ticket.css" type="text/css" />
        <link rel="first" href="1.html" title="Ticket #1" />
        <link rel="shortcut icon" href="../chrome/common/trac.ico" type="image/x-icon" />
        <link rel="icon" href="../chrome/common/trac.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="../search/opensearch" title="Search Mantid Project" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="a82fe30e7bef2e30fd2838e9";
    </script>
    <script type="text/javascript" src="../chrome/common/js/jquery.js"></script><script type="text/javascript" src="../chrome/common/js/babel.js"></script><script type="text/javascript" src="../chrome/common/js/messages/en_US.js"></script><script type="text/javascript" src="../chrome/common/js/trac.js"></script><script type="text/javascript" src="../chrome/common/js/search.js"></script><script type="text/javascript" src="../chrome/common/js/folding.js"></script><script type="text/javascript" src="../chrome/common/js/wikitoolbar.js"></script><script type="text/javascript" src="../chrome/common/js/resizer.js"></script><script type="text/javascript" src="../chrome/common/js/auto_preview.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/mantid/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
        var args = {realm: "ticket", id: 7583, escape_newlines: 0}
        $("#comment").autoPreview("/mantid/wiki_render", args, function(textarea, text, rendered) {
            $("#ticketchange div.comment").html(rendered);
            if (rendered)
              $("#ticketchange").show();
            else if ($("#ticketchange ul.changes").length == 0)
              $("#ticketchange").hide();
        });
        $("#trac-comment-editor textarea").autoPreview("/mantid/wiki_render", args,
                                                       function(textarea, text, rendered) {
          var comment = $("#trac-comment-editor").next("div.comment");
          comment.html(rendered);
          if (rendered)
            comment.show();
          else
            comment.hide();
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
      });
    </script>
    <link rel="stylesheet" type="text/css" href="../chrome/site/style.css" />
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="http://www.mantidproject.org/"><img src="../chrome/site/mantid_logo_with_name.png" alt="Mantid Logo" width="250" /></a>
      </div>
      <form id="search" action="../search.html" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="https://trac.mantidproject.org/mantid/login">Login</a></li><li><a href="../prefs.html">Preferences</a></li><li><a href="../wiki/TracGuide.html">Help/Guide</a></li><li class="last"><a href="../about.html">About Trac</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first"><a href="../wiki.html">Wiki</a></li><li><a href="../timeline.html">Timeline</a></li><li><a href="../roadmap.html">Roadmap</a></li><li class="active"><a href="../report.html">View Tickets</a></li><li class="last"><a href="../search.html">Search</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
          <ul>
              <li class="first"><span>&larr; <a class="prev" href="7582.html" title="Ticket #7582">Previous Ticket</a></span></li><li class="last"><span><a class="next" href="7584.html" title="Ticket #7584">Next Ticket</a> &rarr;</span></li>
          </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="7583.html">Ticket #7583</a>
          <span class="status">(closed: fixed)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-07-30T09%3A51%3A42%2B01%3A00&amp;precision=second" title="2013-07-30T09:51:42+01:00 in Timeline">7 years</a> ago</p>
    <p>Last modified <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-06-04T02%3A01%3A18%2B01%3A00&amp;precision=second" title="2015-06-04T02:01:18+01:00 in Timeline">5 years</a> ago</p>
  </div>
  <h2 class="summary searchable">Crash with quick script that changes log values or instrument parameters</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;reporter=Martyn+Gigg">Martyn Gigg</a>
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;owner=Martyn+Gigg">Martyn Gigg</a>
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;priority=blocker">blocker</a>
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="closed milestone" href="../milestone/Release&#32;2.6.html">Release 2.6</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;component=Framework">Framework</a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
              Alex.Buts@…
        </td>
        <th id="h_blockedby">
          Blocked By:
        </th>
        <td headers="h_blockedby"><span></span></td>
    </tr><tr>
        <th id="h_blocking">
          Blocking:
        </th>
        <td headers="h_blocking"><span></span></td>
        <th id="h_tester">
          Tester:
        </th>
        <td headers="h_tester">
              Russell Taylor
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
      <span class="lastmod" title="2013-07-30 09:02:27.928155+00:00">
        (last modified by Martyn Gigg)
        (<a href="https://trac.mantidproject.org/mantid/ticket/7583?action=diff&amp;version=1">diff</a>)
      </span>
    </h3>
    <div class="searchable">
      <p>
Demonstrated by the script below.
</p>
<div class="code"><pre><span class="kn">import</span> <span class="nn">dgreduce</span>

iliad_setup<span class="o">=</span>dgreduce<span class="o">.</span>setup
iliad<span class="o">=</span>dgreduce<span class="o">.</span>arb_units
iliad_abs<span class="o">=</span>dgreduce<span class="o">.</span>abs_units
iliad_help<span class="o">=</span>dgreduce<span class="o">.</span>help

inst<span class="o">=</span><span class="s">'mar'</span>
iliad_setup<span class="p">(</span>inst<span class="p">)</span>
ext<span class="o">=</span><span class="s">'.raw'</span>
mapfile<span class="o">=</span><span class="s">'mari_res'</span>
cal_file<span class="o">=</span><span class="s">'MAR11060.RAW'</span>
<span class="c">#load vanadium file</span>


<span class="k">for</span> i <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">'############'</span> <span class="p">,</span>i<span class="p">,</span><span class="s">' ##################'</span>
        run<span class="o">=</span><span class="s">'11001'</span>
        WB<span class="o">=</span><span class="s">'11060'</span>
        ei <span class="o">=</span> <span class="mf">12.5</span>
        rebin_params <span class="o">=</span> <span class="s">"-6.25,0.03125,11.875"</span>
        BkgdRange <span class="o">=</span> <span class="p">[</span><span class="mf">11705.726218019521</span><span class="p">,</span> <span class="mi">19500</span><span class="p">]</span>

        w1<span class="o">=</span>iliad<span class="p">(</span>WB<span class="p">,</span>run<span class="p">,</span>ei<span class="p">,</span>rebin_params<span class="p">,</span>mapfile<span class="p">,</span>det_cal_file<span class="o">=</span>cal_file<span class="p">,</span>norm_method<span class="o">=</span><span class="s">'current'</span><span class="p">)</span>
        <span class="c">#w1test=iliad(WB,run,ei,rebin_params,mapfile,det_cal_file=cal_file,norm_method='current',save_format='',background=True,bkgd_range=BkgdRange)</span>
        DeleteWorkspace<span class="p">(</span><span class="s">'w1'</span><span class="p">)</span>
        <span class="c">#DeleteWorkspace('w1test')</span>
</pre></div><p>
that never reaches the end successfully.
</p>
<p>
In release it either shows the terminate dialog saying about m_run being empty or something about a null pointer in the ParameterMap 
</p>

    </div>
  </div>
</div>
          

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="7583.html#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-07-30T10%3A02%3A27%2B01%3A00&amp;precision=second" title="2013-07-30T10:02:27+01:00 in Timeline">7 years</a> ago by Martyn Gigg
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Description</strong>
        modified (<a href="https://trac.mantidproject.org/mantid/ticket/7583?action=diff&amp;version=1">diff</a>)
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="7583.html#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-07-30T17%3A45%3A37%2B01%3A00&amp;precision=second" title="2013-07-30T17:45:37+01:00 in Timeline">7 years</a> ago by Alex Buts
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Cc</strong>
        <em>Alex.Buts@…</em> added
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Yes it is the problem I am experiencing with the Reductuion GUI
</p>

    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="7583.html#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-07-30T20%3A40%3A45%2B01%3A00&amp;precision=second" title="2013-07-30T20:40:45+01:00 in Timeline">7 years</a> ago by Martyn Gigg
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>inprogress</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Lock the DataItem RWLock while generating the ADS tree for the dock.
</p>
<p>
The ADS is now generating a node tree that describes the state
of the ADS when queried. This in turn queries the workspace itself
and while running in MantidPlot an executing script can cause
things wrapped in a cow_ptr to be copied and at the same time
access the pointer while it is being copied, causing a crash.
</p>
<p>
Refs <a class="closed ticket" href="7583.html" title="defect: Crash with quick script that changes log values or instrument parameters (closed: fixed)">#7583</a>
</p>
<p>
Changeset: <a class="changeset" href="https://github.com/mantidproject/mantid/commit/e6de55b899a74120c7da75773190024f12cb0fbc" title="e6de55b899a74120c7da75773190024f12cb0fbc">e6de55b899a74120c7da75773190024f12cb0fbc</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="7583.html#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-07-30T20%3A57%3A16%2B01%3A00&amp;precision=second" title="2013-07-30T20:57:16+01:00 in Timeline">7 years</a> ago by Martyn Gigg
                </h3>
                
    <div class="comment searchable">
      
      <p>
This is not ideal. The dock used to lazy-load the information about a workspace which in-practice avoided this problem because 99% of the time the information was never generated. At this stage in the release it's not possible to put back the lazy loading but the crash needsto be avoided.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-5">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:5" class="cnum">
      <a href="7583.html#comment:5">comment:5</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-07-30T21%3A16%3A29%2B01%3A00&amp;precision=second" title="2013-07-30T21:16:29+01:00 in Timeline">7 years</a> ago by Martyn Gigg
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>inprogress</em> to <em>verify</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>fixed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Branch: bugfix/7583_crash_on_dock_updating
</p>
<p>
Tester: The script above should reproduce the error. It will require the systemtests/Data directory to be in the Mantid search path and to be run from MantidPlot.
</p>
<p>
I would advise running the script <strong>BEFORE</strong> starting to test to ensure that the segfault actually occurs and then merge to the code and test the script again.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-6">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:6" class="cnum">
      <a href="7583.html#comment:6">comment:6</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-07-30T21%3A50%3A24%2B01%3A00&amp;precision=second" title="2013-07-30T21:50:24+01:00 in Timeline">7 years</a> ago by Russell Taylor
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>verify</em> to <em>verifying</em>
    </li><li>
      <strong>Tester</strong>
        set to <em>Russell Taylor</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-7">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:7" class="cnum">
      <a href="7583.html#comment:7">comment:7</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-07-30T23%3A09%3A57%2B01%3A00&amp;precision=second" title="2013-07-30T23:09:57+01:00 in Timeline">7 years</a> ago by Russell Taylor
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>verifying</em> to <em>closed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
OK, it made it through the script 3 times without crashing with that change. I think you could have achieved the same thing (and saved me compilation time!) with a one line change in Workspace.cpp: <tt>Kernel::ReadLock _lock(*this);</tt>
</p>
<p>
We certainly need to get back to laziness in this area.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-8">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:8" class="cnum">
      <a href="7583.html#comment:8">comment:8</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-06-04T02%3A01%3A18%2B01%3A00&amp;precision=second" title="2015-06-04T02:01:18+01:00 in Timeline">5 years</a> ago by Stuart Campbell
                </h3>
                
    <div class="comment searchable">
      
      <p>
This ticket has been transferred to github issue <a class="ext-link" href="http://github.com/mantidproject/mantid/issues/8428"><span class="icon">​</span>8428</a>
</p>

    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="../wiki/TracTickets.html">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <script type="text/javascript">
        jQuery.loadStyleSheet("/mantid/pygments/trac.css", "text/css");
    </script>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/7583?format=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/7583?format=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/7583?format=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="../about.html"><strong>Trac 0.12.5</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the Trac open source project at<br /><a href="http://trac.edgewall.org/">http://trac.edgewall.org/</a></p>
    </div>
  </body>
</html>