<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  


  <head>
    <title>
      #177 (Add a unit version from tof-&gt;wavelength that includes frame unwrapping)
     – Mantid Project
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
        <link rel="search" href="../search.html" />
        <link rel="prev" href="176.html" title="Ticket #176" />
        <link rel="last" href="11888.html" title="Ticket #11888" />
        <link rel="help" href="../wiki/TracGuide.html" />
        <link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/177?format=csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/177?format=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/177?format=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="next" href="178.html" title="Ticket #178" />
        <link rel="start" href="../wiki.html" />
        <link rel="stylesheet" href="../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../chrome/common/css/ticket.css" type="text/css" />
        <link rel="first" href="1.html" title="Ticket #1" />
        <link rel="shortcut icon" href="../chrome/common/trac.ico" type="image/x-icon" />
        <link rel="icon" href="../chrome/common/trac.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="../search/opensearch" title="Search Mantid Project" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="a82fe30e7bef2e30fd2838e9";
    </script>
    <script type="text/javascript" src="../chrome/common/js/jquery.js"></script><script type="text/javascript" src="../chrome/common/js/babel.js"></script><script type="text/javascript" src="../chrome/common/js/messages/en_US.js"></script><script type="text/javascript" src="../chrome/common/js/trac.js"></script><script type="text/javascript" src="../chrome/common/js/search.js"></script><script type="text/javascript" src="../chrome/common/js/folding.js"></script><script type="text/javascript" src="../chrome/common/js/wikitoolbar.js"></script><script type="text/javascript" src="../chrome/common/js/resizer.js"></script><script type="text/javascript" src="../chrome/common/js/auto_preview.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/mantid/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
        var args = {realm: "ticket", id: 177, escape_newlines: 0}
        $("#comment").autoPreview("/mantid/wiki_render", args, function(textarea, text, rendered) {
            $("#ticketchange div.comment").html(rendered);
            if (rendered)
              $("#ticketchange").show();
            else if ($("#ticketchange ul.changes").length == 0)
              $("#ticketchange").hide();
        });
        $("#trac-comment-editor textarea").autoPreview("/mantid/wiki_render", args,
                                                       function(textarea, text, rendered) {
          var comment = $("#trac-comment-editor").next("div.comment");
          comment.html(rendered);
          if (rendered)
            comment.show();
          else
            comment.hide();
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
      });
    </script>
    <link rel="stylesheet" type="text/css" href="../chrome/site/style.css" />
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="http://www.mantidproject.org/"><img src="../chrome/site/mantid_logo_with_name.png" alt="Mantid Logo" width="250" /></a>
      </div>
      <form id="search" action="../search.html" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="https://trac.mantidproject.org/mantid/login">Login</a></li><li><a href="../prefs.html">Preferences</a></li><li><a href="../wiki/TracGuide.html">Help/Guide</a></li><li class="last"><a href="../about.html">About Trac</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first"><a href="../wiki.html">Wiki</a></li><li><a href="../timeline.html">Timeline</a></li><li><a href="../roadmap.html">Roadmap</a></li><li class="active"><a href="../report.html">View Tickets</a></li><li class="last"><a href="../search.html">Search</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
          <ul>
              <li class="first"><span>&larr; <a class="prev" href="176.html" title="Ticket #176">Previous Ticket</a></span></li><li class="last"><span><a class="next" href="178.html" title="Ticket #178">Next Ticket</a> &rarr;</span></li>
          </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="177.html">Ticket #177</a>
          <span class="status">(closed: fixed)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2008-06-30T14%3A45%3A24%2B01%3A00&amp;precision=second" title="2008-06-30T14:45:24+01:00 in Timeline">12 years</a> ago</p>
    <p>Last modified <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-06-03T21%3A51%3A26%2B01%3A00&amp;precision=second" title="2015-06-03T21:51:26+01:00 in Timeline">5 years</a> ago</p>
  </div>
  <h2 class="summary searchable">Add a unit version from tof-&gt;wavelength that includes frame unwrapping</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;reporter=Nick+Draper">Nick Draper</a>
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;owner=Russell+Taylor">Russell Taylor</a>
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;priority=major">major</a>
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="closed milestone" href="../milestone/Iteration&#32;11.html">Iteration 11</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;component"></a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
        <th id="h_blockedby">
          Blocked By:
        </th>
        <td headers="h_blockedby"><span></span></td>
    </tr><tr>
        <th id="h_blocking">
          Blocking:
        </th>
        <td headers="h_blocking"><span></span></td>
        <th id="h_tester">
          Tester:
        </th>
        <td headers="h_tester">
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
This may just be added as an option to the existing conversion.
This should start by using a parameter input to give the lref.
</p>
<p>
Further details from Paolo
Here is a brief summary of the unwrapping issue.  This should be used for white-beam instruments with choppers.  The chopper cut the range of wavelengths, so all detectors (including monitors) should be reduced to the same wavelength range.  This is done using a â€œreferenceâ€ flightpath, Lref, which is (usually, see below) the flightpath of the farthest detectors. If we call Tmin and Tmax the beginning and end of the frame, for each detector D at total flightpath Ld we can define the following times:
</p>
<p>
 
</p>
<p>
T1=Tmax-Tmin*(1-Ld/Lref)
</p>
<p>
T2=Ld/Lref*Tmax
</p>
<p>
 
</p>
<p>
If Ld&lt;Lref then T1&gt;T2
</p>
<p>
 
</p>
<p>
Neutron velocities (and hence wavelengths) for the detector D are calculated in the following way:
</p>
<p>
 
</p>
<ol><li>        Tmin&lt;T&lt;T2:  
</li></ol><p>
 
</p>
<p>
Velocities are calculated in the usual way:  v=Ld/T
</p>
<p>
 
</p>
<ol start="2"><li>        T2&lt;T&lt;T1
</li></ol><p>
 
</p>
<p>
Data at these times are ignored (i.e., they are not used in the wavelength-converted histograms)
</p>
<p>
 
</p>
<ol start="3"><li>        T1&lt;T&lt;Tmax
</li></ol><p>
 
</p>
<p>
Velocities for these points are calculated using the formula v=Ld/(T-Tmax+Tmin)
</p>
<p>
 
</p>
<p>
 
</p>
<p>
Note that the maximum and maximum velocities for the points that are actually *used* are:
</p>
<p>
 
</p>
<p>
vmax=Ld/(T1-Tmax+Tmin)=Lref/Tmin
</p>
<p>
vmin=Ld/T2=Lref/Tmax
</p>
<p>
 
</p>
<p>
In other words, these velocities are the same for all detectors, so the wavelength range in the transformed histogram will correspondingly be the same.
</p>
<p>
 
</p>
<p>
Occasionally, it may be that some detectors (typically downstream monitors) may be at a *longer* flightpath than Lref.  This depends entirely on the chopper aperture/setting. These detectors are â€œframe-overlappedâ€ â€“ in other words, there is an ambiguity in the definition of the wavelength for certain points, which should therefore be excluded.  These points are at the very beginning and at the very end of the frame for a range Dt (equal on both sides) given by
</p>
<p>
 
</p>
<p>
Dt=(Tmax-Tmin)*(1-Lreg/Ld)
</p>
<p>
 
</p>
<p>
In other words, points between Tmin and Tmin+Dt and between Tmax-Dt and Tmax should be excluded.  For all other points, velocities and wavelengths are calculated in the normal way (i.e., according to 1.)
</p>
<p>
 
</p>

    </div>
  </div>
</div>
          

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="177.html#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2008-07-07T14%3A46%3A21%2B01%3A00&amp;precision=second" title="2008-07-07T14:46:21+01:00 in Timeline">12 years</a> ago by Nick Draper
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Owner</strong>
        set to <em>Russell Taylor</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="177.html#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2008-07-15T17%3A04%3A07%2B01%3A00&amp;precision=second" title="2008-07-15T17:04:07+01:00 in Timeline">12 years</a> ago by Russell Taylor
                </h3>
                
    <div class="comment searchable">
      
      <p>
(In <a class="missing changeset" title="No default repository defined">[1200]</a>) Add a const version of the Workspace shared pointer typedef. Re <a class="closed ticket" href="177.html" title="enhancement: Add a unit version from tof-&gt;wavelength that includes frame unwrapping (closed: fixed)">#177</a>.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="177.html#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2008-07-15T17%3A20%3A48%2B01%3A00&amp;precision=second" title="2008-07-15T17:20:48+01:00 in Timeline">12 years</a> ago by Russell Taylor
                </h3>
                
    <div class="comment searchable">
      
      <p>
(In <a class="missing changeset" title="No default repository defined">[1201]</a>) Turns out that was a bad idea (or at least one that requires more thought). Not quite sure why BuildServer was happy because my machine sure wasn't. Re <a class="closed ticket" href="177.html" title="enhancement: Add a unit version from tof-&gt;wavelength that includes frame unwrapping (closed: fixed)">#177</a>.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="177.html#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2008-07-16T13%3A57%3A03%2B01%3A00&amp;precision=second" title="2008-07-16T13:57:03+01:00 in Timeline">12 years</a> ago by Russell Taylor
                </h3>
                
    <div class="comment searchable">
      
      <p>
(In <a class="missing changeset" title="No default repository defined">[1205]</a>) Small error found in create-Workspace-from-parent method. Re <a class="closed ticket" href="177.html" title="enhancement: Add a unit version from tof-&gt;wavelength that includes frame unwrapping (closed: fixed)">#177</a>.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-5">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:5" class="cnum">
      <a href="177.html#comment:5">comment:5</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2008-07-16T15%3A57%3A09%2B01%3A00&amp;precision=second" title="2008-07-16T15:57:09+01:00 in Timeline">12 years</a> ago by Russell Taylor
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>assigned</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-6">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:6" class="cnum">
      <a href="177.html#comment:6">comment:6</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2008-07-29T15%3A58%3A59%2B01%3A00&amp;precision=second" title="2008-07-29T15:58:59+01:00 in Timeline">12 years</a> ago by Nick Draper
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Milestone</strong>
        changed from <em>Iteration 10</em> to <em>Iteration 11</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-7">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:7" class="cnum">
      <a href="177.html#comment:7">comment:7</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2008-08-06T15%3A33%3A31%2B01%3A00&amp;precision=second" title="2008-08-06T15:33:31+01:00 in Timeline">12 years</a> ago by Russell Taylor
                </h3>
                
    <div class="comment searchable">
      
      <p>
(In <a class="missing changeset" title="No default repository defined">[1275]</a>) Adding an Unwrap algorithm to deal with frame unwrapping (and conversion to wavelength). Re <a class="closed ticket" href="177.html" title="enhancement: Add a unit version from tof-&gt;wavelength that includes frame unwrapping (closed: fixed)">#177</a>.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-8">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:8" class="cnum">
      <a href="177.html#comment:8">comment:8</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2008-09-01T16%3A59%3A28%2B01%3A00&amp;precision=second" title="2008-09-01T16:59:28+01:00 in Timeline">12 years</a> ago by Russell Taylor
                </h3>
                
    <div class="comment searchable">
      
      <p>
(In <a class="missing changeset" title="No default repository defined">[1328]</a>) Added handling of frame overlapping in Unwrap algorithm. Re <a class="closed ticket" href="177.html" title="enhancement: Add a unit version from tof-&gt;wavelength that includes frame unwrapping (closed: fixed)">#177</a>.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-9">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:9" class="cnum">
      <a href="177.html#comment:9">comment:9</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2008-09-05T09%3A56%3A46%2B01%3A00&amp;precision=second" title="2008-09-05T09:56:46+01:00 in Timeline">12 years</a> ago by Russell Taylor
                </h3>
                
    <div class="comment searchable">
      
      <p>
(In <a class="missing changeset" title="No default repository defined">[1343]</a>) Added (incomplete) HRP definition file. Re <a class="closed ticket" href="177.html" title="enhancement: Add a unit version from tof-&gt;wavelength that includes frame unwrapping (closed: fixed)">#177</a>.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-10">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:10" class="cnum">
      <a href="177.html#comment:10">comment:10</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2008-09-05T15%3A12%3A41%2B01%3A00&amp;precision=second" title="2008-09-05T15:12:41+01:00 in Timeline">12 years</a> ago by Russell Taylor
                </h3>
                
    <div class="comment searchable">
      
      <p>
(In <a class="missing changeset" title="No default repository defined">[1344]</a>) Very subtle change required to avoid problems with bounds checking in the VS vector implementation. Re <a class="closed ticket" href="177.html" title="enhancement: Add a unit version from tof-&gt;wavelength that includes frame unwrapping (closed: fixed)">#177</a>.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-11">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:11" class="cnum">
      <a href="177.html#comment:11">comment:11</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2008-09-05T16%3A24%3A34%2B01%3A00&amp;precision=second" title="2008-09-05T16:24:34+01:00 in Timeline">12 years</a> ago by Russell Taylor
                </h3>
                
    <div class="comment searchable">
      
      <p>
(In <a class="missing changeset" title="No default repository defined">[1345]</a>) Add test data files for unwrapping. Re <a class="closed ticket" href="177.html" title="enhancement: Add a unit version from tof-&gt;wavelength that includes frame unwrapping (closed: fixed)">#177</a>.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-12">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:12" class="cnum">
      <a href="177.html#comment:12">comment:12</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2008-09-05T16%3A39%3A34%2B01%3A00&amp;precision=second" title="2008-09-05T16:39:34+01:00 in Timeline">12 years</a> ago by Russell Taylor
                </h3>
                
    <div class="comment searchable">
      
      <p>
(In <a class="missing changeset" title="No default repository defined">[1346]</a>) Modified DiffractionFocussing to throw if reading the grouping file fails.
Adding most basic of tests for Unwrap, DiffractionFocussing &amp; AlignDetectors.
Re <a class="closed ticket" href="177.html" title="enhancement: Add a unit version from tof-&gt;wavelength that includes frame unwrapping (closed: fixed)">#177</a>.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-13">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:13" class="cnum">
      <a href="177.html#comment:13">comment:13</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2008-09-05T16%3A45%3A23%2B01%3A00&amp;precision=second" title="2008-09-05T16:45:23+01:00 in Timeline">12 years</a> ago by Russell Taylor
                </h3>
                
    <div class="comment searchable">
      
      <p>
(In <a class="missing changeset" title="No default repository defined">[1347]</a>) Put wrong extension on test file. Re <a class="closed ticket" href="177.html" title="enhancement: Add a unit version from tof-&gt;wavelength that includes frame unwrapping (closed: fixed)">#177</a>.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-14">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:14" class="cnum">
      <a href="177.html#comment:14">comment:14</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2008-09-05T17%3A42%3A51%2B01%3A00&amp;precision=second" title="2008-09-05T17:42:51+01:00 in Timeline">12 years</a> ago by Russell Taylor
                </h3>
                
    <div class="comment searchable">
      
      <p>
(In <a class="missing changeset" title="No default repository defined">[1348]</a>) Trying to fix tests. Re <a class="closed ticket" href="177.html" title="enhancement: Add a unit version from tof-&gt;wavelength that includes frame unwrapping (closed: fixed)">#177</a>.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-15">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:15" class="cnum">
      <a href="177.html#comment:15">comment:15</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2008-09-08T13%3A06%3A37%2B01%3A00&amp;precision=second" title="2008-09-08T13:06:37+01:00 in Timeline">12 years</a> ago by Russell Taylor
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>assigned</em> to <em>closed</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>fixed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
This is done, though an extended test should be written.
Also, Paolo has the following ideas for how this algorithm could be generalised a little:
</p>
<p>
With respect to the original algorithm, I think we should make a couple of very simple changes to make it more amenable for use with the geometry.  I refer to the notations I used in my previous e-mail (I still have a copy if you need it).  This approach should work with all white-beam instruments (most instruments at ISIS, except for the chopper spectrometers).
</p>
<p>
The input parameters are:
</p>
<p>
DeltaT, vmax, vmin, Lref.  If Lref is present, vmax and vmin can have default values.  If vmax and vmin are present, Lref is not used.
</p>
<p>
The default values are:
</p>
<p>
DeltaT=Tmax-Tmin (these being the min and max times in the TOF frame)
</p>
<p>
vmax=Lref/Tmin
</p>
<p>
vmin=Lref/Tmax
</p>
<p>
Then, the calculation proceeds in a very similar way as before, with the definitions:
</p>
<p>
T1=DeltaT+Ld/vmax or T1=DeltaT if vmax=infinity or a negative number
</p>
<p>
T2=Ld/vmin
</p>
<p>
Neutron velocities (and hence wavelengths) for the detector D at distance Ld are calculated in the following way:
</p>
<ol><li>        Tmin&lt;T&lt;T2: 
</li></ol><p>
Velocities are calculated in the usual way:  v=Ld/T
</p>
<ol start="2"><li>        T2&lt;T&lt;T1
</li></ol><blockquote>
<p>
Data at these times are ignored (i.e., they are not used in the wavelength-converted histograms)
</p>
</blockquote>
<ol start="3"><li>        T1&lt;T&lt;Tmax
</li></ol><p>
Velocities for these points are calculated using the formula v=Ld/(T-DeltaT)
</p>
<p>
As I noted in the previous e-mail, some of the detectors (particularly transmission monitors) can be frame-overlapped.  This happens for
</p>
<p>
Ld&gt;DeltaT*(1/vmin-1/vmax)<sup>-1
</sup></p>
<p>
In this case, T1&lt;T2, and all the points between T1 and T2 should be masked out.  This will result in a useful wavelength range that is smaller than for the other detectors.
</p>
<p>
Should we have access to geometrical/frequency/phase information of the choppers, the input values can all be calculated (and Lref becomes unnecessary) as follows (I write this for future reference):
</p>
<p>
vmax=d_chop/Topen
</p>
<p>
vmin=d_chop/Tclose
</p>
<p>
DeltaT=1/Frequency
</p>
<p>
Note that there could be more than one chopper, in which case vmax=min(vmax1, vmax2â€¦), vmin=max(vmin1, vmin2â€¦), and DeltaT=max(DeltaT1, DeltaT2â€¦).
</p>
<p>
Topen and Tclose can be calculated from the chopper phase, which should be logged, and from the chopper opening angle alpha and the offset between the pick-up and the slit opening, which are geometrical properties.
</p>
<p>
Topen=phase+offset/(2*Pi*frequency)
</p>
<p>
Tclose=Topen+alpha/(2*Pi*frequency)
</p>
<p>
If Tclose&gt;DeltaT then Tclose=Tclose-DeltaT and Topen=Topen-DeltaT (this can be iterated, although it is unlikely that anyone would set the choppers more than one frame ahead)
</p>
<p>
Note also that Topen can be zero or negative, in which case vmax=infinity or a negative number (the case is dealt with above).
</p>

    </div>

              </div>
              <div class="change" id="trac-change-16">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:16" class="cnum">
      <a href="177.html#comment:16">comment:16</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-06-03T21%3A51%3A26%2B01%3A00&amp;precision=second" title="2015-06-03T21:51:26+01:00 in Timeline">5 years</a> ago by Stuart Campbell
                </h3>
                
    <div class="comment searchable">
      
      <p>
This ticket has been transferred to github issue <a class="ext-link" href="http://github.com/mantidproject/mantid/issues/1025"><span class="icon">​</span>1025</a>
</p>

    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="../wiki/TracTickets.html">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/177?format=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/177?format=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/177?format=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="../about.html"><strong>Trac 0.12.5</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the Trac open source project at<br /><a href="http://trac.edgewall.org/">http://trac.edgewall.org/</a></p>
    </div>
  </body>
</html>