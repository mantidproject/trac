<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  


  <head>
    <title>
      #7743 (Slow down of reduction after running it through many loops)
     – Mantid Project
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
        <link rel="search" href="../search.html" />
        <link rel="prev" href="7742.html" title="Ticket #7742" />
        <link rel="last" href="11888.html" title="Ticket #11888" />
        <link rel="help" href="../wiki/TracGuide.html" />
        <link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/7743?format=csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/7743?format=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/7743?format=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="next" href="7744.html" title="Ticket #7744" />
        <link rel="start" href="../wiki.html" />
        <link rel="stylesheet" href="../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../chrome/common/css/ticket.css" type="text/css" />
        <link rel="first" href="1.html" title="Ticket #1" />
        <link rel="shortcut icon" href="../chrome/common/trac.ico" type="image/x-icon" />
        <link rel="icon" href="../chrome/common/trac.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="../search/opensearch" title="Search Mantid Project" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="a82fe30e7bef2e30fd2838e9";
    </script>
    <script type="text/javascript" src="../chrome/common/js/jquery.js"></script><script type="text/javascript" src="../chrome/common/js/babel.js"></script><script type="text/javascript" src="../chrome/common/js/messages/en_US.js"></script><script type="text/javascript" src="../chrome/common/js/trac.js"></script><script type="text/javascript" src="../chrome/common/js/search.js"></script><script type="text/javascript" src="../chrome/common/js/folding.js"></script><script type="text/javascript" src="../chrome/common/js/wikitoolbar.js"></script><script type="text/javascript" src="../chrome/common/js/resizer.js"></script><script type="text/javascript" src="../chrome/common/js/auto_preview.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/mantid/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
        var args = {realm: "ticket", id: 7743, escape_newlines: 0}
        $("#comment").autoPreview("/mantid/wiki_render", args, function(textarea, text, rendered) {
            $("#ticketchange div.comment").html(rendered);
            if (rendered)
              $("#ticketchange").show();
            else if ($("#ticketchange ul.changes").length == 0)
              $("#ticketchange").hide();
        });
        $("#trac-comment-editor textarea").autoPreview("/mantid/wiki_render", args,
                                                       function(textarea, text, rendered) {
          var comment = $("#trac-comment-editor").next("div.comment");
          comment.html(rendered);
          if (rendered)
            comment.show();
          else
            comment.hide();
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
      });
    </script>
    <link rel="stylesheet" type="text/css" href="../chrome/site/style.css" />
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="http://www.mantidproject.org/"><img src="../chrome/site/mantid_logo_with_name.png" alt="Mantid Logo" width="250" /></a>
      </div>
      <form id="search" action="../search.html" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="https://trac.mantidproject.org/mantid/login">Login</a></li><li><a href="../prefs.html">Preferences</a></li><li><a href="../wiki/TracGuide.html">Help/Guide</a></li><li class="last"><a href="../about.html">About Trac</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first"><a href="../wiki.html">Wiki</a></li><li><a href="../timeline.html">Timeline</a></li><li><a href="../roadmap.html">Roadmap</a></li><li class="active"><a href="../report.html">View Tickets</a></li><li class="last"><a href="../search.html">Search</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
          <ul>
              <li class="first"><span>&larr; <a class="prev" href="7742.html" title="Ticket #7742">Previous Ticket</a></span></li><li class="last"><span><a class="next" href="7744.html" title="Ticket #7744">Next Ticket</a> &rarr;</span></li>
          </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="7743.html">Ticket #7743</a>
          <span class="status">(closed: fixed)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-08-13T11%3A25%3A08%2B01%3A00&amp;precision=second" title="2013-08-13T11:25:08+01:00 in Timeline">7 years</a> ago</p>
    <p>Last modified <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-06-04T02%3A07%3A55%2B01%3A00&amp;precision=second" title="2015-06-04T02:07:55+01:00 in Timeline">5 years</a> ago</p>
  </div>
  <h2 class="summary searchable">Slow down of reduction after running it through many loops</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;reporter=Martyn+Gigg">Martyn Gigg</a>
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;owner=Martyn+Gigg">Martyn Gigg</a>
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;priority=critical">critical</a>
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="closed milestone" href="../milestone/Release&#32;3.0.html">Release 3.0</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;component=Direct+Inelastic">Direct Inelastic</a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
        <th id="h_blockedby">
          Blocked By:
        </th>
        <td headers="h_blockedby"><span></span></td>
    </tr><tr>
        <th id="h_blocking">
          Blocking:
        </th>
        <td headers="h_blocking"><span></span></td>
        <th id="h_tester">
          Tester:
        </th>
        <td headers="h_tester">
              Russell Taylor
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
This script demonstrates the problem (data is in systemtests). If you look at the timing of the reduction then it increases a lot between the first few runs and the last.
</p>
<div class="code"><pre><span class="kn">import</span> <span class="nn">mantid</span>
<span class="kn">from</span> <span class="nn">mantid.simpleapi</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">dgreduce</span>

iliad_setup<span class="o">=</span>dgreduce<span class="o">.</span>setup
iliad<span class="o">=</span>dgreduce<span class="o">.</span>arb_units
iliad_abs<span class="o">=</span>dgreduce<span class="o">.</span>abs_units
iliad_help<span class="o">=</span>dgreduce<span class="o">.</span>help

inst<span class="o">=</span><span class="s">'mar'</span>
iliad_setup<span class="p">(</span>inst<span class="p">)</span>
ext<span class="o">=</span><span class="s">'.raw'</span>
mapfile<span class="o">=</span><span class="s">'mari_res'</span>
<span class="c">#det_cal_file must be specified if the reduction sends out put to a workpsace #cal_file='MAR17578.raw'</span>
cal_file<span class="o">=</span><span class="s">'MAR11060.RAW'</span>
<span class="c">#load vanadium file</span>


<span class="k">for</span> i <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">'############'</span> <span class="p">,</span>i<span class="p">,</span><span class="s">' ##################'</span>
        run<span class="o">=</span><span class="s">'11001'</span>
        WB<span class="o">=</span><span class="s">'MAR11060.RAW'</span>
        ei <span class="o">=</span> <span class="mf">12.5</span>
        rebin_params <span class="o">=</span> <span class="s">"-6.25,0.03125,11.875"</span>
        BkgdRange <span class="o">=</span> <span class="p">[</span><span class="mf">11705.726218019521</span><span class="p">,</span> <span class="mi">19500</span><span class="p">]</span>

        w1<span class="o">=</span>iliad<span class="p">(</span>WB<span class="p">,</span>run<span class="p">,</span>ei<span class="p">,</span>rebin_params<span class="p">,</span>mapfile<span class="p">,</span>det_cal_file<span class="o">=</span>cal_file<span class="p">,</span>norm_method<span class="o">=</span><span class="s">'current'</span><span class="p">)</span>
        DeleteWorkspace<span class="p">(</span><span class="s">'w1'</span><span class="p">)</span>
</pre></div>
    </div>
  </div>
</div>
          

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="7743.html#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-08-19T13%3A09%3A22%2B01%3A00&amp;precision=second" title="2013-08-19T13:09:22+01:00 in Timeline">7 years</a> ago by Martyn Gigg
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>inprogress</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Fix bug when loading duplicate instrument parameters.
</p>
<p>
The multimap was continuously growing as there was no way of checking
if a given parameter for a component was already loaded. The storage
is now a map with key &lt;Component*,name&gt; so that only unique
component/named pairs will be stored.
Refs <a class="closed ticket" href="7743.html" title="defect: Slow down of reduction after running it through many loops (closed: fixed)">#7743</a>.
</p>
<p>
Changeset: <a class="changeset" href="https://github.com/mantidproject/mantid/commit/c34a3597e9d84d01bc0619c4aa202c111e914f03" title="c34a3597e9d84d01bc0619c4aa202c111e914f03">c34a3597e9d84d01bc0619c4aa202c111e914f03</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="7743.html#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-08-19T13%3A09%3A22%2B01%3A00&amp;precision=second" title="2013-08-19T13:09:22+01:00 in Timeline">7 years</a> ago by Martyn Gigg
                </h3>
                
    <div class="comment searchable">
      
      <p>
Fix case when no log exists for parameter link.
</p>
<p>
Also, improved error message for LoadEmptyInstrument
when running child algorithm.
Refs <a class="closed ticket" href="7743.html" title="defect: Slow down of reduction after running it through many loops (closed: fixed)">#7743</a>
</p>
<p>
Changeset: <a class="changeset" href="https://github.com/mantidproject/mantid/commit/48ed7f59d88050f2e0de14c178e86920a054b805" title="48ed7f59d88050f2e0de14c178e86920a054b805">48ed7f59d88050f2e0de14c178e86920a054b805</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="7743.html#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-08-19T13%3A09%3A22%2B01%3A00&amp;precision=second" title="2013-08-19T13:09:22+01:00 in Timeline">7 years</a> ago by Martyn Gigg
                </h3>
                
    <div class="comment searchable">
      
      <p>
Add equality operator to ParameterMap...
</p>
<p>
and use it in CheckWorkspacesMatch. This avoids changes in ordering
within the map affecting whether the map is actually the same as another.
Refs <a class="closed ticket" href="7743.html" title="defect: Slow down of reduction after running it through many loops (closed: fixed)">#7743</a>
</p>
<p>
Changeset: <a class="changeset" href="https://github.com/mantidproject/mantid/commit/4b7aee01301d57493c72b16e0dcb28de8ec18efa" title="4b7aee01301d57493c72b16e0dcb28de8ec18efa">4b7aee01301d57493c72b16e0dcb28de8ec18efa</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="7743.html#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-08-19T17%3A38%3A52%2B01%3A00&amp;precision=second" title="2013-08-19T17:38:52+01:00 in Timeline">7 years</a> ago by Martyn Gigg
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>inprogress</em> to <em>verify</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>fixed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Branch: bugfix/7743_reduction_looping_slow_down
</p>
<p>
Tester: Before merging the changes confirm to yourself that the processing of each iteration takes longer as the script keeps executing (it prints the loop time after each iteration). 
</p>
<p>
Merge the changes and rerun the the script above. Confirm that each loop now takes roughly the same time, with the exception of the first that has to load the instrument.
</p>
<p>
Check that the systemtests have been run (i.e there has been at least one night between the changes going to develop and the point you are testing) and are passing.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-5">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:5" class="cnum">
      <a href="7743.html#comment:5">comment:5</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-08-19T22%3A26%3A36%2B01%3A00&amp;precision=second" title="2013-08-19T22:26:36+01:00 in Timeline">7 years</a> ago by Russell Taylor
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>verify</em> to <em>verifying</em>
    </li><li>
      <strong>Tester</strong>
        set to <em>Russell Taylor</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-6">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:6" class="cnum">
      <a href="7743.html#comment:6">comment:6</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-08-20T17%3A41%3A12%2B01%3A00&amp;precision=second" title="2013-08-20T17:41:12+01:00 in Timeline">7 years</a> ago by Russell Taylor
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>verifying</em> to <em>closed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
After the changes there is no slowdown trend when running the above script. I am relying fairly heavily on the tests to validate the changes, but they look good and have certainly cleaned things up in certain places.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-7">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:7" class="cnum">
      <a href="7743.html#comment:7">comment:7</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-10-23T11%3A10%3A08%2B01%3A00&amp;precision=second" title="2013-10-23T11:10:08+01:00 in Timeline">7 years</a> ago by Nick Draper
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Component</strong>
        changed from <em>Framework</em> to <em>Direct Inelastic</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-8">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:8" class="cnum">
      <a href="7743.html#comment:8">comment:8</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-06-04T02%3A07%3A55%2B01%3A00&amp;precision=second" title="2015-06-04T02:07:55+01:00 in Timeline">5 years</a> ago by Stuart Campbell
                </h3>
                
    <div class="comment searchable">
      
      <p>
This ticket has been transferred to github issue <a class="ext-link" href="http://github.com/mantidproject/mantid/issues/8588"><span class="icon">​</span>8588</a>
</p>

    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="../wiki/TracTickets.html">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <script type="text/javascript">
        jQuery.loadStyleSheet("/mantid/pygments/trac.css", "text/css");
    </script>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/7743?format=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/7743?format=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/7743?format=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="../about.html"><strong>Trac 0.12.5</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the Trac open source project at<br /><a href="http://trac.edgewall.org/">http://trac.edgewall.org/</a></p>
    </div>
  </body>
</html>