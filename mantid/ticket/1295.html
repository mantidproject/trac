<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  


  <head>
    <title>
      #1295 (Mantid terminates using LoadNexus and then deleting some of the periods)
     â€“ Mantid Project
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
        <link rel="search" href="../search.html" />
        <link rel="prev" href="1294.html" title="Ticket #1294" />
        <link rel="last" href="11888.html" title="Ticket #11888" />
        <link rel="help" href="../wiki/TracGuide.html" />
        <link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/1295?format=csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/1295?format=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/1295?format=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="next" href="1296.html" title="Ticket #1296" />
        <link rel="start" href="../wiki.html" />
        <link rel="stylesheet" href="../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../chrome/common/css/ticket.css" type="text/css" />
        <link rel="first" href="1.html" title="Ticket #1" />
        <link rel="shortcut icon" href="../chrome/common/trac.ico" type="image/x-icon" />
        <link rel="icon" href="../chrome/common/trac.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="../search/opensearch" title="Search Mantid Project" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="a82fe30e7bef2e30fd2838e9";
    </script>
    <script type="text/javascript" src="../chrome/common/js/jquery.js"></script><script type="text/javascript" src="../chrome/common/js/babel.js"></script><script type="text/javascript" src="../chrome/common/js/messages/en_US.js"></script><script type="text/javascript" src="../chrome/common/js/trac.js"></script><script type="text/javascript" src="../chrome/common/js/search.js"></script><script type="text/javascript" src="../chrome/common/js/folding.js"></script><script type="text/javascript" src="../chrome/common/js/wikitoolbar.js"></script><script type="text/javascript" src="../chrome/common/js/resizer.js"></script><script type="text/javascript" src="../chrome/common/js/auto_preview.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/mantid/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
        var args = {realm: "ticket", id: 1295, escape_newlines: 0}
        $("#comment").autoPreview("/mantid/wiki_render", args, function(textarea, text, rendered) {
            $("#ticketchange div.comment").html(rendered);
            if (rendered)
              $("#ticketchange").show();
            else if ($("#ticketchange ul.changes").length == 0)
              $("#ticketchange").hide();
        });
        $("#trac-comment-editor textarea").autoPreview("/mantid/wiki_render", args,
                                                       function(textarea, text, rendered) {
          var comment = $("#trac-comment-editor").next("div.comment");
          comment.html(rendered);
          if (rendered)
            comment.show();
          else
            comment.hide();
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
      });
    </script>
    <link rel="stylesheet" type="text/css" href="../chrome/site/style.css" />
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="http://www.mantidproject.org/"><img src="../chrome/site/mantid_logo_with_name.png" alt="Mantid Logo" width="250" /></a>
      </div>
      <form id="search" action="../search.html" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="https://trac.mantidproject.org/mantid/login">Login</a></li><li><a href="../prefs.html">Preferences</a></li><li><a href="../wiki/TracGuide.html">Help/Guide</a></li><li class="last"><a href="../about.html">About Trac</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first"><a href="../wiki.html">Wiki</a></li><li><a href="../timeline.html">Timeline</a></li><li><a href="../roadmap.html">Roadmap</a></li><li class="active"><a href="../report.html">View Tickets</a></li><li class="last"><a href="../search.html">Search</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
          <ul>
              <li class="first"><span>&larr; <a class="prev" href="1294.html" title="Ticket #1294">Previous Ticket</a></span></li><li class="last"><span><a class="next" href="1296.html" title="Ticket #1296">Next Ticket</a> &rarr;</span></li>
          </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="1295.html">Ticket #1295</a>
          <span class="status">(closed: fixed)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2010-06-03T10%3A55%3A00%2B01%3A00&amp;precision=second" title="2010-06-03T10:55:00+01:00 in Timeline">10 years</a> ago</p>
    <p>Last modified <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-06-03T22%3A31%3A05%2B01%3A00&amp;precision=second" title="2015-06-03T22:31:05+01:00 in Timeline">5 years</a> ago</p>
  </div>
  <h2 class="summary searchable">Mantid terminates using LoadNexus and then deleting some of the periods</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;reporter=Steve+Williams">Steve Williams</a>
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;owner=Roman+Tolchenov">Roman Tolchenov</a>
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;priority=critical">critical</a>
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="closed milestone" href="../milestone/Iteration&#32;23.html">Iteration 23</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;component"></a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
        <th id="h_blockedby">
          Blocked By:
        </th>
        <td headers="h_blockedby"><span></span></td>
    </tr><tr>
        <th id="h_blocking">
          Blocking:
        </th>
        <td headers="h_blocking"><span></span></td>
        <th id="h_tester">
          Tester:
        </th>
        <td headers="h_tester">
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
The following script is from the SANS scripts and deals with loading a multi-period Nexus file and deleting all but 1 period.
It crashes Mantidplot on _my_ computer when logging to file is set to warning, logging to information seems to slow things down enough to stop the conflict. It doesn't crash when run from the command prompt. Problem around add and remove from workspace group signals to Mantidplot's workspace list?
</p>
<pre class="wiki">def _leaveSinglePeriod(groupW, period):
    oldName = groupW.getName()+'_'+str(period)
    #move this workspace out of the group (this doesn't delete it)
    groupW.remove(oldName)

    newName = groupW.getName()+'p'+str(period)
    
    #remove the rest of the group
    mtd.deleteWorkspace(groupW.getName())
    return newName

def _loadRawData(filename, wsName, ext, spec_min = None, spec_max = None, period = -1):
    alg = LoadNexus(filename + '.' + ext, wsName,SpectrumMin=spec_min,SpectrumMax=spec_max)

    pWorksp = mtd[wsName]

    if pWorksp.isGroup() :
        #get the number of periods in a group using the fact that each period has a different name
        nNames = len(pWorksp.getNames())
        numPeriods = nNames - 1
    else :
        #if the work space isn't a group there is only one period
        numPeriods = 1
        
    #period greater than one means we must be looking at a workspace group
    if period &gt; 1 :
        if not pWorksp.isGroup() : raise Exception('_loadRawData: A period number can only be specified for a group and workspace '+ pWorksp.getName() + ' is not a group')
        wsName = _leaveSinglePeriod(pWorksp, period)
	pWorksp = mtd[wsName]
    else :
        #if it is a group but they hadn't specified the period it means load the first spectrum
        if pWorksp.isGroup() :
            wsName = _leaveSinglePeriod(pWorksp, 1)
            pWorksp = mtd[wsName]
    
    # Return the filepath actually used to load the data
    fullpath = alg.getPropertyValue("Filename")
    return [ os.path.dirname(fullpath), wsName, numPeriods]

def _assignHelper(run_string, period = -1):
    wkspname =  '5508_sans_nxs'

    filename = os.path.join(DATA_PATH,'SANS2D00005508')
    
    [filepath, wkspname, nPeriods] = _loadRawData(filename, wkspname, 'nxs', None, None, period)
            
    return True, filepath, nPeriods

DATA_PATH = '//isis/inst$/cycle_10_1/NDXSANS2D/'
print _assignHelper('5508.nxs', 11)
</pre>
    </div>
  </div>
</div>
          

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="1295.html#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2010-06-04T12%3A01%3A33%2B01%3A00&amp;precision=second" title="2010-06-04T12:01:33+01:00 in Timeline">10 years</a> ago by Steve Williams
                </h3>
                
    <div class="comment searchable">
      
      <p>
This Python causes the same crashes on my machine
</p>
<pre class="wiki">alg = LoadNexus("//isis/inst$/NDXSANS2D/Instrument/data/cycle_10_1/SANS2D00005508.nxs, '5508_sans_nxs')
worksp = alg.getPropertyValue("OutputWorkspace")
mtd[worksp].remove('5508_sans_nxs_11')
mtd.deleteWorkspace(worksp)
</pre><p>
The following C++ is equivalent but runs OK in main(). Moving the code into Mantidplot should cause the same crash.
</p>
<pre class="wiki">#include &lt;iostream&gt;
#include &lt;iomanip&gt;
#include "Benchmark.h"
#include "UserAlgorithmTest.h"
#include "MantidAPI/FrameworkManager.h" 
#include "MantidDataObjects/Workspace2D.h" 
#include "MantidAPI/WorkspaceGroup.h"

#include &lt;boost/timer.hpp&gt;

using namespace Mantid::API;
using namespace Mantid::Kernel;
using namespace Mantid::Geometry;
using namespace Mantid::DataObjects;

int main()
{

  FrameworkManagerImpl&amp; fm = FrameworkManager::Instance();

  IAlgorithm* alg = fm.createAlgorithm("LoadNexus");
  alg-&gt;setPropertyValue("Filename", "//isis/inst$/NDXSANS2D/Instrument/data/cycle_10_1/SANS2D00005508.nxs");
  alg-&gt;setPropertyValue("OutputWorkspace", "5508_sans_nxs");    
  alg-&gt;execute();
  
  Workspace* ws = fm.getWorkspace("5508_sans_nxs");
  WorkspaceGroup* group = dynamic_cast&lt;WorkspaceGroup*&gt;(ws);
  if ( ! group )
  {
    std::cout &lt;&lt; "no cast";
    return 1;
  }
  group-&gt;remove("5508_sans_nxs_11");
  FrameworkManager::Instance().deleteWorkspace("5508_sans_nxs");

  std::cout &lt;&lt; "done ---------";

  fm.clear();
  exit(0);

}
</pre>
    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="1295.html#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2010-06-04T14%3A38%3A28%2B01%3A00&amp;precision=second" title="2010-06-04T14:38:28+01:00 in Timeline">10 years</a> ago by Steve Williams
                </h3>
                
    <div class="comment searchable">
      
      <p>
The problem caused by the Analysis Data service sends a QT signal to the Mantidplot GUI but doesn't wait for the SLOT function to complete before changing the contents of the Analysis Data service again.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="1295.html#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2010-06-08T09%3A53%3A59%2B01%3A00&amp;precision=second" title="2010-06-08T09:53:59+01:00 in Timeline">10 years</a> ago by Nick Draper
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>closed</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>fixed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="1295.html#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-06-03T22%3A31%3A05%2B01%3A00&amp;precision=second" title="2015-06-03T22:31:05+01:00 in Timeline">5 years</a> ago by Stuart Campbell
                </h3>
                
    <div class="comment searchable">
      
      <p>
This ticket has been transferred to github issue <a class="ext-link" href="http://github.com/mantidproject/mantid/issues/2142"><span class="icon">â€‹</span>2142</a>
</p>

    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="../wiki/TracTickets.html">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/1295?format=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/1295?format=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/1295?format=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="../about.html"><strong>Trac 0.12.5</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the Trac open source project at<br /><a href="http://trac.edgewall.org/">http://trac.edgewall.org/</a></p>
    </div>
  </body>
</html>