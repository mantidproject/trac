<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  


  <head>
    <title>
      #9634 (Allow Setting of Sample Geom and Provide Sensible Defaults in Reduction)
     – Mantid Project
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
        <link rel="search" href="../search.html" />
        <link rel="prev" href="9633.html" title="Ticket #9633" />
        <link rel="last" href="11888.html" title="Ticket #11888" />
        <link rel="help" href="../wiki/TracGuide.html" />
        <link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/9634?format=csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/9634?format=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/9634?format=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="next" href="9635.html" title="Ticket #9635" />
        <link rel="start" href="../wiki.html" />
        <link rel="stylesheet" href="../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../chrome/common/css/ticket.css" type="text/css" />
        <link rel="first" href="1.html" title="Ticket #1" />
        <link rel="shortcut icon" href="../chrome/common/trac.ico" type="image/x-icon" />
        <link rel="icon" href="../chrome/common/trac.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="../search/opensearch" title="Search Mantid Project" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="a82fe30e7bef2e30fd2838e9";
    </script>
    <script type="text/javascript" src="../chrome/common/js/jquery.js"></script><script type="text/javascript" src="../chrome/common/js/babel.js"></script><script type="text/javascript" src="../chrome/common/js/messages/en_US.js"></script><script type="text/javascript" src="../chrome/common/js/trac.js"></script><script type="text/javascript" src="../chrome/common/js/search.js"></script><script type="text/javascript" src="../chrome/common/js/folding.js"></script><script type="text/javascript" src="../chrome/common/js/wikitoolbar.js"></script><script type="text/javascript" src="../chrome/common/js/resizer.js"></script><script type="text/javascript" src="../chrome/common/js/auto_preview.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/mantid/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
        var args = {realm: "ticket", id: 9634, escape_newlines: 0}
        $("#comment").autoPreview("/mantid/wiki_render", args, function(textarea, text, rendered) {
            $("#ticketchange div.comment").html(rendered);
            if (rendered)
              $("#ticketchange").show();
            else if ($("#ticketchange ul.changes").length == 0)
              $("#ticketchange").hide();
        });
        $("#trac-comment-editor textarea").autoPreview("/mantid/wiki_render", args,
                                                       function(textarea, text, rendered) {
          var comment = $("#trac-comment-editor").next("div.comment");
          comment.html(rendered);
          if (rendered)
            comment.show();
          else
            comment.hide();
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
      });
    </script>
    <link rel="stylesheet" type="text/css" href="../chrome/site/style.css" />
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="http://www.mantidproject.org/"><img src="../chrome/site/mantid_logo_with_name.png" alt="Mantid Logo" width="250" /></a>
      </div>
      <form id="search" action="../search.html" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="https://trac.mantidproject.org/mantid/login">Login</a></li><li><a href="../prefs.html">Preferences</a></li><li><a href="../wiki/TracGuide.html">Help/Guide</a></li><li class="last"><a href="../about.html">About Trac</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first"><a href="../wiki.html">Wiki</a></li><li><a href="../timeline.html">Timeline</a></li><li><a href="../roadmap.html">Roadmap</a></li><li class="active"><a href="../report.html">View Tickets</a></li><li class="last"><a href="../search.html">Search</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
          <ul>
              <li class="first"><span>&larr; <a class="prev" href="9633.html" title="Ticket #9633">Previous Ticket</a></span></li><li class="last"><span><a class="next" href="9635.html" title="Ticket #9635">Next Ticket</a> &rarr;</span></li>
          </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="9634.html">Ticket #9634</a>
          <span class="status">(closed: fixed)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-06-11T10%3A45%3A43%2B01%3A00&amp;precision=second" title="2014-06-11T10:45:43+01:00 in Timeline">6 years</a> ago</p>
    <p>Last modified <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-06-04T03%3A26%3A24%2B01%3A00&amp;precision=second" title="2015-06-04T03:26:24+01:00 in Timeline">5 years</a> ago</p>
  </div>
  <h2 class="summary searchable">Allow Setting of Sample Geom and Provide Sensible Defaults in Reduction</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;reporter=Peter+Parker">Peter Parker</a>
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;owner=Peter+Parker">Peter Parker</a>
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;priority=critical">critical</a>
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="closed milestone" href="../milestone/Release&#32;3.2.html">Release 3.2</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;component=SANS">SANS</a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
              robert.dalgliesh@…
        </td>
        <th id="h_blockedby">
          Blocked By:
        </th>
        <td headers="h_blockedby"><span></span></td>
    </tr><tr>
        <th id="h_blocking">
          Blocking:
        </th>
        <td headers="h_blocking"><span></span></td>
        <th id="h_tester">
          Tester:
        </th>
        <td headers="h_tester">
              Samuel Jackson
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
LARMOR is currently producing data files that do not have have sample thickness values set.  He is having to use the NeXuS API to manually go in to the files and set them himself.
</p>
<p>
We need to do the following:
</p>
<ul><li>Expose setThickness (and other related methods) of the MutableSample class to Python, so that he make make the necessary changes via a script.
</li></ul><ul><li>Have the reducer do something sensible when it is not provided with sample geom values (or values of 0.0).  The way the GUI and reduction pass values back and forth to each other is quite convoluted, so I need to be careful about where exactly these defaults should be set.
</li></ul>
    </div>
  </div>
</div>
          

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="9634.html#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-06-11T10%3A46%3A10%2B01%3A00&amp;precision=second" title="2014-06-11T10:46:10+01:00 in Timeline">6 years</a> ago by Peter Parker
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Cc</strong>
        <em>robert.dalgliesh@…</em> added
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="9634.html#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-06-13T11%3A16%3A53%2B01%3A00&amp;precision=second" title="2014-06-13T11:16:53+01:00 in Timeline">6 years</a> ago by Nick Draper
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>assigned</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="9634.html#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-06-18T10%3A13%3A33%2B01%3A00&amp;precision=second" title="2014-06-18T10:13:33+01:00 in Timeline">6 years</a> ago by Peter Parker
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>assigned</em> to <em>inprogress</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Refs <a class="closed ticket" href="9634.html" title="enhancement: Allow Setting of Sample Geom and Provide Sensible Defaults in Reduction (closed: fixed)">#9634</a> - Expose sample geom methods and guard against 0.0.
</p>
<p>
Changeset: <a class="changeset" href="https://github.com/mantidproject/mantid/commit/4c975cb7ddc47558a8deab258aaff48f5b17b949" title="4c975cb7ddc47558a8deab258aaff48f5b17b949">4c975cb7ddc47558a8deab258aaff48f5b17b949</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="9634.html#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-06-18T10%3A27%3A57%2B01%3A00&amp;precision=second" title="2014-06-18T10:27:57+01:00 in Timeline">6 years</a> ago by Peter Parker
                </h3>
                
    <div class="comment searchable">
      
      <p>
To test:
</p>
<p>
Run the following script to test that the exposed geom sample "setters" have the desired effect when used:
</p>
<div class="code"><pre><span class="kn">import</span> <span class="nn">os</span>

<span class="c"># Found in \\isis\inst$\Instruments$\NDXLARMOR\Instrument\data\cycle_14_1:</span>
ws <span class="o">=</span> Load<span class="p">(</span><span class="s">"LARMOR00000217.nxs"</span><span class="p">)</span>

<span class="k">print</span> <span class="s">"On loading the file, the sample geom values are all 0.0:"</span>
<span class="k">print</span> ws<span class="o">.</span>sample<span class="p">()</span><span class="o">.</span>getThickness<span class="p">()</span>
<span class="k">print</span> ws<span class="o">.</span>sample<span class="p">()</span><span class="o">.</span>getWidth<span class="p">()</span>
<span class="k">print</span> ws<span class="o">.</span>sample<span class="p">()</span><span class="o">.</span>getHeight<span class="p">()</span>

ws<span class="o">.</span>sample<span class="p">()</span><span class="o">.</span>setThickness<span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
ws<span class="o">.</span>sample<span class="p">()</span><span class="o">.</span>setWidth<span class="p">(</span><span class="mf">3.0</span><span class="p">)</span>
ws<span class="o">.</span>sample<span class="p">()</span><span class="o">.</span>setHeight<span class="p">(</span><span class="mf">4.0</span><span class="p">)</span>

<span class="k">print</span> <span class="s">"The values have now been changed:"</span>
<span class="k">print</span> ws<span class="o">.</span>sample<span class="p">()</span><span class="o">.</span>getThickness<span class="p">()</span>
<span class="k">print</span> ws<span class="o">.</span>sample<span class="p">()</span><span class="o">.</span>getWidth<span class="p">()</span>
<span class="k">print</span> ws<span class="o">.</span>sample<span class="p">()</span><span class="o">.</span>getHeight<span class="p">()</span>

file_path <span class="o">=</span> os<span class="o">.</span>path<span class="o">.</span>join<span class="p">(</span>config<span class="p">[</span><span class="s">"defaultsave.directory"</span><span class="p">],</span>
                         <span class="s">"changed_sample_geom.nxs"</span><span class="p">)</span>
SaveNexus<span class="p">(</span>ws<span class="p">,</span> file_path<span class="p">)</span>
roundtrip_ws <span class="o">=</span> Load<span class="p">(</span>file_path<span class="p">)</span>

<span class="k">print</span> <span class="s">"The values survive being saved out and then loaded again:"</span>
<span class="k">print</span> roundtrip_ws<span class="o">.</span>sample<span class="p">()</span><span class="o">.</span>getThickness<span class="p">()</span>
<span class="k">print</span> roundtrip_ws<span class="o">.</span>sample<span class="p">()</span><span class="o">.</span>getWidth<span class="p">()</span>
<span class="k">print</span> roundtrip_ws<span class="o">.</span>sample<span class="p">()</span><span class="o">.</span>getHeight<span class="p">()</span>

os<span class="o">.</span>remove<span class="p">(</span>file_path<span class="p">)</span>
</pre></div><p>
Then run this script, to show that the reduction stops and clearly presents an error to a user when any of the sample geom values are 0.0:
</p>
<div class="code"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">ISISCommandInterface</span> <span class="kn">as</span> <span class="nn">ici</span>

<span class="c"># LARMOR files wont go through the reducer yet, so let's read in a </span>
<span class="c"># SANS2D run from the system tests folder that we know will go</span>
<span class="c"># through, and then modify its sample geom values to be 0.0.</span>
ws <span class="o">=</span> LoadNexus<span class="p">(</span><span class="s">"SANS2D00022048.nxs"</span><span class="p">)</span>

ws<span class="o">.</span>sample<span class="p">()</span><span class="o">.</span>setThickness<span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
ws<span class="o">.</span>sample<span class="p">()</span><span class="o">.</span>setWidth<span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
ws<span class="o">.</span>sample<span class="p">()</span><span class="o">.</span>setHeight<span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

file_path <span class="o">=</span> os<span class="o">.</span>path<span class="o">.</span>join<span class="p">(</span>config<span class="p">[</span><span class="s">"defaultsave.directory"</span><span class="p">],</span> <span class="s">"modified.nxs"</span><span class="p">)</span>
SaveNexus<span class="p">(</span>ws<span class="p">,</span> file_path<span class="p">)</span>

<span class="c"># Set up the reducer.</span>
ici<span class="o">.</span>SANS2D<span class="p">()</span>
ici<span class="o">.</span>MaskFile<span class="p">(</span><span class="s">'MaskSANS2DReductionGUI.txt'</span><span class="p">)</span>
ici<span class="o">.</span>AssignSample<span class="p">(</span>file_path<span class="p">)</span>

<span class="c"># Now run the reduction.  Previously this would have given us A LOT of</span>
<span class="c"># "Division by zero: the RHS is a single-valued vector with value zero."</span>
<span class="c"># warnings and the reducer would carry on regardless.  Now it should raise</span>
<span class="c"># a RuntimeError and stop completely, making it obvious what went wrong.</span>
reduced <span class="o">=</span> ici<span class="o">.</span>WavRangeReduction<span class="p">()</span>
</pre></div><p>
Now test the GUI:
</p>
<ul><li>Open the ISIS SANS interface and select "SANS2D" in the instrument dropdown box.
</li></ul><ul><li>Load the "MaskSANS2DReductionGUI.txt" User File from the "/Data/SANS2D/" folder of the system tests repo.
</li></ul><ul><li>In the Scattering/Sample MWRunFiles widget, browse to the "modified.nxs" data file that was saved to your default save directory by the script above.
</li></ul><ul><li>Clicking "Load Data" should now show three warnings in the Results Log.
</li></ul><ul><li>Go to "Reduction Settings" tab and ensure that a default value of 1 has been put in thickness, width and height sample geometry text fields.
</li></ul><ul><li>Go back to the first tab, and click "1D Reduce".  The reduction should complete without any errors.
</li></ul>
    </div>

              </div>
              <div class="change" id="trac-change-5">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:5" class="cnum">
      <a href="9634.html#comment:5">comment:5</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-06-18T16%3A28%3A36%2B01%3A00&amp;precision=second" title="2014-06-18T16:28:36+01:00 in Timeline">6 years</a> ago by Peter Parker
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>inprogress</em> to <em>verify</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>fixed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-6">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:6" class="cnum">
      <a href="9634.html#comment:6">comment:6</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-06-20T14%3A58%3A01%2B01%3A00&amp;precision=second" title="2014-06-20T14:58:01+01:00 in Timeline">6 years</a> ago by Samuel Jackson
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>verify</em> to <em>verifying</em>
    </li><li>
      <strong>Tester</strong>
        set to <em>Samuel Jackson</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-7">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:7" class="cnum">
      <a href="9634.html#comment:7">comment:7</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-06-20T15%3A54%3A58%2B01%3A00&amp;precision=second" title="2014-06-20T15:54:58+01:00 in Timeline">6 years</a> ago by Samuel Jackson
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>verifying</em> to <em>closed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Merge remote-tracking branch 'origin/feature/9634_sample_geom_isis_sans'
</p>
<p>
Full changeset: <a class="ext-link" href="https://github.com/mantidproject/mantid/commit/2c21b7ff7702d7af74516d9808ace5b83c147242"><span class="icon">​</span>2c21b7ff7702d7af74516d9808ace5b83c147242</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-8">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:8" class="cnum">
      <a href="9634.html#comment:8">comment:8</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-06-04T03%3A26%3A24%2B01%3A00&amp;precision=second" title="2015-06-04T03:26:24+01:00 in Timeline">5 years</a> ago by Stuart Campbell
                </h3>
                
    <div class="comment searchable">
      
      <p>
This ticket has been transferred to github issue <a class="ext-link" href="http://github.com/mantidproject/mantid/issues/10477"><span class="icon">​</span>10477</a>
</p>

    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="../wiki/TracTickets.html">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <script type="text/javascript">
        jQuery.loadStyleSheet("/mantid/pygments/trac.css", "text/css");
    </script>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/9634?format=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/9634?format=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/9634?format=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="../about.html"><strong>Trac 0.12.5</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the Trac open source project at<br /><a href="http://trac.edgewall.org/">http://trac.edgewall.org/</a></p>
    </div>
  </body>
</html>