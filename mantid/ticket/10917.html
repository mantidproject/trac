<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  


  <head>
    <title>
      #10917 (Subtle bug in ISIS reduction)
     – Mantid Project
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
        <link rel="search" href="../search.html" />
        <link rel="prev" href="10916.html" title="Ticket #10916" />
        <link rel="last" href="11888.html" title="Ticket #11888" />
        <link rel="help" href="../wiki/TracGuide.html" />
        <link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/10917?format=csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/10917?format=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/10917?format=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="next" href="10918.html" title="Ticket #10918" />
        <link rel="start" href="../wiki.html" />
        <link rel="stylesheet" href="../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../chrome/common/css/ticket.css" type="text/css" />
        <link rel="first" href="1.html" title="Ticket #1" />
        <link rel="shortcut icon" href="../chrome/common/trac.ico" type="image/x-icon" />
        <link rel="icon" href="../chrome/common/trac.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="../search/opensearch" title="Search Mantid Project" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="a82fe30e7bef2e30fd2838e9";
    </script>
    <script type="text/javascript" src="../chrome/common/js/jquery.js"></script><script type="text/javascript" src="../chrome/common/js/babel.js"></script><script type="text/javascript" src="../chrome/common/js/messages/en_US.js"></script><script type="text/javascript" src="../chrome/common/js/trac.js"></script><script type="text/javascript" src="../chrome/common/js/search.js"></script><script type="text/javascript" src="../chrome/common/js/folding.js"></script><script type="text/javascript" src="../chrome/common/js/wikitoolbar.js"></script><script type="text/javascript" src="../chrome/common/js/resizer.js"></script><script type="text/javascript" src="../chrome/common/js/auto_preview.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/mantid/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
        var args = {realm: "ticket", id: 10917, escape_newlines: 0}
        $("#comment").autoPreview("/mantid/wiki_render", args, function(textarea, text, rendered) {
            $("#ticketchange div.comment").html(rendered);
            if (rendered)
              $("#ticketchange").show();
            else if ($("#ticketchange ul.changes").length == 0)
              $("#ticketchange").hide();
        });
        $("#trac-comment-editor textarea").autoPreview("/mantid/wiki_render", args,
                                                       function(textarea, text, rendered) {
          var comment = $("#trac-comment-editor").next("div.comment");
          comment.html(rendered);
          if (rendered)
            comment.show();
          else
            comment.hide();
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
      });
    </script>
    <link rel="stylesheet" type="text/css" href="../chrome/site/style.css" />
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="http://www.mantidproject.org/"><img src="../chrome/site/mantid_logo_with_name.png" alt="Mantid Logo" width="250" /></a>
      </div>
      <form id="search" action="../search.html" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="https://trac.mantidproject.org/mantid/login">Login</a></li><li><a href="../prefs.html">Preferences</a></li><li><a href="../wiki/TracGuide.html">Help/Guide</a></li><li class="last"><a href="../about.html">About Trac</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first"><a href="../wiki.html">Wiki</a></li><li><a href="../timeline.html">Timeline</a></li><li><a href="../roadmap.html">Roadmap</a></li><li class="active"><a href="../report.html">View Tickets</a></li><li class="last"><a href="../search.html">Search</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
          <ul>
              <li class="first"><span>&larr; <a class="prev" href="10916.html" title="Ticket #10916">Previous Ticket</a></span></li><li class="last"><span><a class="next" href="10918.html" title="Ticket #10918">Next Ticket</a> &rarr;</span></li>
          </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="10917.html">Ticket #10917</a>
          <span class="status">(closed: fixed)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-16T18%3A05%3A40Z&amp;precision=second" title="2015-01-16T18:05:40Z in Timeline">6 years</a> ago</p>
    <p>Last modified <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-06-04T04%3A16%3A21%2B01%3A00&amp;precision=second" title="2015-06-04T04:16:21+01:00 in Timeline">5 years</a> ago</p>
  </div>
  <h2 class="summary searchable">Subtle bug in ISIS reduction</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;reporter=Alex+Buts">Alex Buts</a>
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;owner=Alex+Buts">Alex Buts</a>
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;priority=major">major</a>
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="closed milestone" href="../milestone/Release&#32;3.4.html">Release 3.4</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;component=Framework">Framework</a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
        <th id="h_blockedby">
          Blocked By:
        </th>
        <td headers="h_blockedby"><span></span></td>
    </tr><tr>
        <th id="h_blocking">
          Blocking:
        </th>
        <td headers="h_blocking"><span></span></td>
        <th id="h_tester">
          Tester:
        </th>
        <td headers="h_tester">
              Federico M Pouzols
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
ISIS Reduction script for Merlin provided below fails with current Mantid. 
Fix is trivial but should be done for current reduction to work. 
</p>
<pre class="wiki">""" Sample MERLIN reduction scrip """ 
import os
os.environ["PATH"] = r"d:\Data\Mantid_GIT_test\Code\builds\br_master\bin\Release;"+os.environ["PATH"]

from ReductionWrapper import *
try:
    import reduce_vars as rv
except:
    rv = None


class ReduceMERLIN(ReductionWrapper):
   @MainProperties
   def def_main_properties(self):
       """ Define main properties used in reduction """ 


       prop = {};
       prop['sample_run'] = 18995;
       prop['wb_run'] = 18962
       prop['incident_energy'] = 18;
       prop['energy_bins'] = [-10, 0.2, 15]

       
      # Absolute units reduction properties.
       #prop['monovan_run'] = 17589
       #prop['sample_mass'] = 10/(94.4/13) # -- this number allows to get approximately the same system test intensities for MAPS as the old test
       #prop['sample_rmm'] = 435.96 #
       return prop

   @AdvancedProperties
   def def_advanced_properties(self):
      """  separation between simple and advanced properties depends
           on scientist, experiment and user.
           main properties override advanced properties.      
      """
      prop = {};
      prop['map_file'] = 'one2one_125.map'
      #prop['monovan_mapfile'] = 'default' #'4to1_mid_lowang.map' # default
      prop['hardmaskOnly'] ='Bjorn_mask.msk'
      prop['det_cal_file'] = 'det_corr_125.dat' #
      prop['save_format']=''
      
      return prop;
      #
   @iliad
   def main(self,input_file=None,output_directory=None):
     # run reduction, write auxiliary script to add something here.

       red = DirectEnergyConversion()
       red.initialise(self.iliad_prop)
       runno=range(18995,19100)    
       ei=[52,23]       
       ebin=[-0.5,0.005,0.950]
       bg_range=[12000,19000] #  change from 12000 to 16000 for 7meV range of times to take background in
       # loads the whitebeam (or rather the long monovan ). Does it as a raw file to save time as the event mode is very large
       present_run=-1
       if 'wb_wksp' in mtd:
            m=mtd['wb_wksp']
            present_run= m.getRunNumber()
       if present_run !=red.prop_man.wb_run:
            LoadRaw(Filename=str(red.prop_man.wb_run),OutputWorkspace="wb_wksp") # load whitebeam
       

       for run in runno:     #loop around runs
            file='MER'+str(run)+'.nxs'

            LoadEventNexus(Filename=file,OutputWorkspace='w1',SingleBankPixelsOnly='0',LoadMonitors='1',MonitorsAsEvents='0',Precount=True)
            AddSampleLog(Workspace='w1',LogName='run_number',LogText=str(run),LogType='Number') #only have to do this as run_number is passed to workspace for event files

            ExtractSingleSpectrum(InputWorkspace='w1_monitors',OutputWorkspace='mon',WorkspaceIndex='5')  #extract monitor 6
            Rebin(InputWorkspace='mon',OutputWorkspace='mon',Params=[1000,100,90000])
            ConvertToMatrixWorkspace(InputWorkspace='mon',OutputWorkspace='mon')
            ConvertUnits(InputWorkspace='mon',OutputWorkspace='mon',Target='Energy')
            NormaliseByCurrent(InputWorkspace='mon',OutputWorkspace='mon')     #monitor 6 converted to energy and normalised



            #now loop around all energies for the run
            for energy in ei:
                energy=float(energy)
                print (energy)
                emin=0.05*energy   #minimum energy is with 80% energy loss
                lam=(81.81/energy)**0.5
                lam_max=(81.81/emin)**0.5
                tsam=252.82*lam*11.8   #time at sample
                tmon2=252.82*lam*10. #time to monitor 2 on MERLIN
                tmax=tsam+(252.82*lam_max*2.8868) #maximum time to measure inelastic signal to
                t_elastic=tsam+(252.82*lam*2.8868)   #maximum time of elastic signal
                tbin=[int(tmon2),1.0,int(tmax)]
                energybin=[ebin[0]*energy,ebin[1]*energy,ebin[2]*energy]
                energybin = [ '%.4f' % elem for elem in energybin ]  
                ebinstring=str(energybin[0])+','+str(energybin[1])+','+str(energybin[2])
                print ebinstring

                Rebin(InputWorkspace='w1',OutputWorkspace='w1reb',Params=[tmon2,1.0,tmax],PreserveEvents=False)
                Rebin(InputWorkspace='w1_monitors',OutputWorkspace='w1_mon',Params=[tmon2,1.0,tmax],PreserveEvents=False)

                ######################################################################
                ConjoinWorkspaces(InputWorkspace1='w1reb',InputWorkspace2='w1_mon')	
                # diag does not always work well on MERLIN. At present only use a hard mask HCW has create
                out=red.convert_to_energy("wb_wksp","w1reb",energy,ebinstring,fixei=False,bleed=True,norm_method='current',\
                          detector_van_range=[0.5,200])
                SaveNXSPE("out",'MER'+str(run)+'_'+str(energy)+'meV_one2one125.nxspe')     

       #when run from web service, return additional path for web server to copy data to";
       return ""

   def __init__(self):
       """ sets properties defaults for the instrument with Name"""
       ReductionWrapper.__init__(self,'MER',rv)
#----------------------------------------------------------------------------------------------------------------------



if __name__=="__main__":
  
     #maps_dir ='/home/merlin/mprogs/InstrumentFiles/merlin/'  
     #maps_dir = 'd:/Data/MantidSystemTests/Data'
     maps_dir = r'c:\Users\wkc26243\Documents\work\InstrumentFiles\merlin'
     data_dir ='d:/Data/Mantid_Testing/14_12_15'
     ref_data_dir = 'd:/Data/MantidSystemTests/SystemTests/AnalysisTests/ReferenceResults' 
     config.setDataSearchDirs('{0};{1};{2}'.format(data_dir,maps_dir,ref_data_dir))
     #config.appendDataSearchDir('d:/Data/Mantid_GIT/Test/AutoTestData')
     config['defaultsave.directory'] = data_dir # folder to save resulting spe/nxspe files. Defaults are in

     # execute stuff from Mantid
     rd = ReduceMERLIN()
     rd.def_advanced_properties()
     rd.def_main_properties()


     rd.main()


</pre>
    </div>
  </div>
</div>
          

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="10917.html#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-16T18%3A07%3A08Z&amp;precision=second" title="2015-01-16T18:07:08Z in Timeline">6 years</a> ago by Alex Buts
                </h3>
                
    <div class="comment searchable">
      
      <p>
Re <a class="closed ticket" href="10917.html" title="Subtle bug in ISIS reduction (closed: fixed)">#10917</a> This should fix it
</p>
<p>
Changeset: <a class="changeset" href="https://github.com/mantidproject/mantid/commit/5b43f7a9f3e306355f835fabdd93b035b6d85a79" title="5b43f7a9f3e306355f835fabdd93b035b6d85a79">5b43f7a9f3e306355f835fabdd93b035b6d85a79</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="10917.html#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-16T18%3A26%3A22Z&amp;precision=second" title="2015-01-16T18:26:22Z in Timeline">6 years</a> ago by Alex Buts
                </h3>
                
    <div class="comment searchable">
      
      <p>
To tester -- This is trivial fix but it make sense only if it goes to Release 3.3
</p>
<p>
I made substantial changes for Release 3.4 which should fix bug and make this ticket unnecessary. 
</p>
<p>
The branch remains just as reference point for some time. 
</p>

    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="10917.html#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-16T18%3A29%3A57Z&amp;precision=second" title="2015-01-16T18:29:57Z in Timeline">6 years</a> ago by Alex Buts
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>assigned</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="10917.html#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-17T18%3A05%3A30Z&amp;precision=second" title="2015-01-17T18:05:30Z in Timeline">6 years</a> ago by Alex Buts
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>assigned</em> to <em>verify</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>fixed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-5">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:5" class="cnum">
      <a href="10917.html#comment:5">comment:5</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-23T09%3A32%3A10Z&amp;precision=second" title="2015-01-23T09:32:10Z in Timeline">6 years</a> ago by Federico M Pouzols
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>verify</em> to <em>verifying</em>
    </li><li>
      <strong>Tester</strong>
        set to <em>Federico M Pouzols</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-6">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:6" class="cnum">
      <a href="10917.html#comment:6">comment:6</a>
    </span>
                          <span>follow-up:</span>
      <a href="10917.html#comment:7">↓ 7</a>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-23T09%3A32%3A49Z&amp;precision=second" title="2015-01-23T09:32:49Z in Timeline">6 years</a> ago by Federico M Pouzols
                </h3>
                
    <div class="comment searchable">
      
      <p>
Is this ticket fixed and should it be merged into master, or has it become invalid?
</p>

    </div>

              </div>
              <div class="change" id="trac-change-7">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:7" class="cnum">
      <a href="10917.html#comment:7">comment:7</a>
    </span>
                        in reply to:
      <a href="10917.html#comment:6">↑ 6</a>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-23T10%3A39%3A27Z&amp;precision=second" title="2015-01-23T10:39:27Z in Timeline">6 years</a> ago by Alex Buts
                </h3>
                
    <div class="comment searchable">
      
      <p>
Replying to <a href="10917.html#comment:6" title="Comment 6 for Ticket #10917">Federico M Pouzols</a>:
</p>
<p>
Its fixed but should not be merged to master -- I made changes to develop which make this ticket redundant. (and they may be already in master)  But this is bugfix for reduction  in Release 3.3, so this should sit ready to case if somebody needs it for release 3.3 and is not ready to change to develop version or pull the changes I made to reduction. 
</p>
<p>
I think this just should stay as it is for a while in case of patch release is requested
 
</p>

    </div>

                <div class="trac-lastedit ">
                  Last edited <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-23T11%3A12%3A28Z&amp;precision=second" title="2015-01-23T11:12:28Z in Timeline">6 years</a> ago
                      by Alex Buts
                    (<a href="https://trac.mantidproject.org/mantid/ticket/10917?cversion=0&amp;cnum_hist=7#comment:7">previous</a>)
                    (<a href="https://trac.mantidproject.org/mantid/ticket/10917?action=comment-diff&amp;cnum=7&amp;version=1">diff</a>)
                </div>
              </div>
              <div class="change" id="trac-change-8">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:8" class="cnum">
      <a href="10917.html#comment:8">comment:8</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-04-27T10%3A09%3A06%2B01%3A00&amp;precision=second" title="2015-04-27T10:09:06+01:00 in Timeline">5 years</a> ago by Nick Draper
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>verifying</em> to <em>closed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
ticket closed without merging
</p>

    </div>

              </div>
              <div class="change" id="trac-change-9">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:9" class="cnum">
      <a href="10917.html#comment:9">comment:9</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-06-04T04%3A16%3A21%2B01%3A00&amp;precision=second" title="2015-06-04T04:16:21+01:00 in Timeline">5 years</a> ago by Stuart Campbell
                </h3>
                
    <div class="comment searchable">
      
      <p>
This ticket has been transferred to github issue <a class="ext-link" href="http://github.com/mantidproject/mantid/issues/11756"><span class="icon">​</span>11756</a>
</p>

    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="../wiki/TracTickets.html">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/10917?format=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/10917?format=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/10917?format=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="../about.html"><strong>Trac 0.12.5</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the Trac open source project at<br /><a href="http://trac.edgewall.org/">http://trac.edgewall.org/</a></p>
    </div>
  </body>
</html>