<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  


  <head>
    <title>
      #8172 (Nexus file-loading clean-up)
     – Mantid Project
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
        <link rel="search" href="../search.html" />
        <link rel="prev" href="8171.html" title="Ticket #8171" />
        <link rel="last" href="11888.html" title="Ticket #11888" />
        <link rel="help" href="../wiki/TracGuide.html" />
        <link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/8172?format=csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/8172?format=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/8172?format=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="next" href="8173.html" title="Ticket #8173" />
        <link rel="start" href="../wiki.html" />
        <link rel="stylesheet" href="../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../chrome/common/css/ticket.css" type="text/css" />
        <link rel="first" href="1.html" title="Ticket #1" />
        <link rel="shortcut icon" href="../chrome/common/trac.ico" type="image/x-icon" />
        <link rel="icon" href="../chrome/common/trac.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="../search/opensearch" title="Search Mantid Project" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="a82fe30e7bef2e30fd2838e9";
    </script>
    <script type="text/javascript" src="../chrome/common/js/jquery.js"></script><script type="text/javascript" src="../chrome/common/js/babel.js"></script><script type="text/javascript" src="../chrome/common/js/messages/en_US.js"></script><script type="text/javascript" src="../chrome/common/js/trac.js"></script><script type="text/javascript" src="../chrome/common/js/search.js"></script><script type="text/javascript" src="../chrome/common/js/folding.js"></script><script type="text/javascript" src="../chrome/common/js/wikitoolbar.js"></script><script type="text/javascript" src="../chrome/common/js/resizer.js"></script><script type="text/javascript" src="../chrome/common/js/auto_preview.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/mantid/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
        var args = {realm: "ticket", id: 8172, escape_newlines: 0}
        $("#comment").autoPreview("/mantid/wiki_render", args, function(textarea, text, rendered) {
            $("#ticketchange div.comment").html(rendered);
            if (rendered)
              $("#ticketchange").show();
            else if ($("#ticketchange ul.changes").length == 0)
              $("#ticketchange").hide();
        });
        $("#trac-comment-editor textarea").autoPreview("/mantid/wiki_render", args,
                                                       function(textarea, text, rendered) {
          var comment = $("#trac-comment-editor").next("div.comment");
          comment.html(rendered);
          if (rendered)
            comment.show();
          else
            comment.hide();
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
      });
    </script>
    <link rel="stylesheet" type="text/css" href="../chrome/site/style.css" />
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="http://www.mantidproject.org/"><img src="../chrome/site/mantid_logo_with_name.png" alt="Mantid Logo" width="250" /></a>
      </div>
      <form id="search" action="../search.html" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="https://trac.mantidproject.org/mantid/login">Login</a></li><li><a href="../prefs.html">Preferences</a></li><li><a href="../wiki/TracGuide.html">Help/Guide</a></li><li class="last"><a href="../about.html">About Trac</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first"><a href="../wiki.html">Wiki</a></li><li><a href="../timeline.html">Timeline</a></li><li><a href="../roadmap.html">Roadmap</a></li><li class="active"><a href="../report.html">View Tickets</a></li><li class="last"><a href="../search.html">Search</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
          <ul>
              <li class="first"><span>&larr; <a class="prev" href="8171.html" title="Ticket #8171">Previous Ticket</a></span></li><li><span><a class="next" href="8173.html" title="Ticket #8173">Next Ticket</a> &rarr;</span></li><li class="last"><a href="../depgraph/8172.html">Depgraph</a></li>
          </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="8172.html">Ticket #8172</a>
          <span class="status">(closed: fixed)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-10-21T19%3A09%3A20%2B01%3A00&amp;precision=second" title="2013-10-21T19:09:20+01:00 in Timeline">7 years</a> ago</p>
    <p>Last modified <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-06-04T02%3A25%3A44%2B01%3A00&amp;precision=second" title="2015-06-04T02:25:44+01:00 in Timeline">5 years</a> ago</p>
  </div>
  <h2 class="summary searchable">Nexus file-loading clean-up</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;reporter=Russell+Taylor">Russell Taylor</a>
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;owner=Federico+M+Pouzols">Federico M Pouzols</a>
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;priority=major">major</a>
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="closed milestone" href="../milestone/Release&#32;3.4.html">Release 3.4</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;component=Framework">Framework</a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
              <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;keywords=~Maintenance">Maintenance</a>, <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;keywords=~CORE">CORE</a>
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
        <th id="h_blockedby">
          Blocked By:
        </th>
        <td headers="h_blockedby"><span></span></td>
    </tr><tr>
        <th id="h_blocking">
          Blocking:
        </th>
        <td headers="h_blocking"><span><a class="inprogress ticket" href="10619.html" title="LoadEventNexus (+ LoadNexusMonitors and other LoadNexus...) cleaning/maintenance">#10619</a></span></td>
        <th id="h_tester">
          Tester:
        </th>
        <td headers="h_tester">
              Harry Jeffery
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
I noticed a number of things concerning the loading of nexus files (in LoadEventNexus) when working on <a class="closed ticket" href="8108.html" title="enhancement: SNS ADARA files: Load the instrument from the Nexus file (closed: fixed)">#8108</a>.
</p>
<p>
For example:
</p>
<ul><li>If you choose to load monitors, the logs and instrument are loaded again. This seems unnecessary.
</li><li>If LoadIDFFromNexus is called as a child algorithm, the nexus file is opened again even though it's already open in the parent.
</li><li>....I'll add more as I remember them
</li></ul>
    </div>
  </div>
</div>
          
    <div id="attachments">
        <h2 class="foldable">Attachments</h2>
        <div>
          <dl class="attachments">
              <dt>
    <a href="../attachment/ticket/8172/DataHandlingTest.LoadEventNexusTestPerformance.testDefaultLoad.runtime.v.revision.png.html" title="View attachment">DataHandlingTest.LoadEventNexusTestPerformance.testDefaultLoad.runtime.v.revision.png</a><a href="../raw-attachment/ticket/8172/DataHandlingTest.LoadEventNexusTestPerformance.testDefaultLoad.runtime.v.revision.png" class="trac-rawlink" title="Download">​</a>
       (<span title="55430 bytes">54.1 KB</span>) -
      added by <em>Russell Taylor</em> <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-10-29T13%3A52%3A16Z&amp;precision=second" title="2013-10-29T13:52:16Z in Timeline">7 years</a> ago.
  </dt>
          </dl>
          
        </div>
    </div>

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change">
                <h3 class="change">
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-10-29T13%3A52%3A16Z&amp;precision=second" title="2013-10-29T13:52:16Z in Timeline">7 years</a> ago by Russell Taylor
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Attachment</strong>
        <a href="../attachment/ticket/8172/DataHandlingTest.LoadEventNexusTestPerformance.testDefaultLoad.runtime.v.revision.png.html"><em>DataHandlingTest.LoadEventNexusTestPerformance.testDefaultLoad.runtime.v.revision.png</em></a><a href="../raw-attachment/ticket/8172/DataHandlingTest.LoadEventNexusTestPerformance.testDefaultLoad.runtime.v.revision.png" title="Download" class="trac-rawlink">​</a>
          added
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="8172.html#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2013-10-29T13%3A53%3A17Z&amp;precision=second" title="2013-10-29T13:53:17Z in Timeline">7 years</a> ago by Russell Taylor
                </h3>
                
    <div class="comment searchable">
      
      <p>
The performance test suggest that my changes in <a class="closed ticket" href="8108.html" title="enhancement: SNS ADARA files: Load the instrument from the Nexus file (closed: fixed)">#8108</a> slowed LoadEventNexus (for the tested file at least) by about 10%. Looking at that should be a focus of this ticket as well.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="8172.html#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-02-14T11%3A05%3A01Z&amp;precision=second" title="2014-02-14T11:05:01Z in Timeline">7 years</a> ago by Nick Draper
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>assigned</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Bulk move to assigned at the introduction of the triage step
</p>

    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="8172.html#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-12-10T13%3A01%3A47Z&amp;precision=second" title="2014-12-10T13:01:47Z in Timeline">6 years</a> ago by Federico M Pouzols
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Blocking</strong>
        <em>10619</em> added
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
(In <a class="inprogress ticket" href="10619.html" title="LoadEventNexus (+ LoadNexusMonitors and other LoadNexus...) ... (inprogress)">#10619</a>) I just found an old related ticket: <a class="closed ticket" href="8172.html" title="task: Nexus file-loading clean-up (closed: fixed)">#8172</a>.
Add the issues described there to the list of points to check here, and close that ticket when this one is done.
 
</p>

    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="8172.html#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-12-10T13%3A04%3A13Z&amp;precision=second" title="2014-12-10T13:04:13Z in Timeline">6 years</a> ago by Federico M Pouzols
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Owner</strong>
        set to <em>Federico M Pouzols</em>
    </li><li>
      <strong>Blocking</strong>
        <em>10619</em> removed
    </li><li>
      <strong>Milestone</strong>
        changed from <em>Backlog</em> to <em>Release 3.4</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="8172.html#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-12-12T09%3A50%3A57Z&amp;precision=second" title="2014-12-12T09:50:57Z in Timeline">6 years</a> ago by Federico M Pouzols
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Blocking</strong>
        <em>10619</em> added
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
(In <a class="inprogress ticket" href="10619.html" title="LoadEventNexus (+ LoadNexusMonitors and other LoadNexus...) ... (inprogress)">#10619</a>) It seems that I removed the 'blocked by' inadvertently.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-6">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:6" class="cnum">
      <a href="8172.html#comment:6">comment:6</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-07T16%3A29%3A35Z&amp;precision=second" title="2015-01-07T16:29:35Z in Timeline">6 years</a> ago by Federico Montesino Pouzols
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>assigned</em> to <em>inprogress</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
avoid loading insturment twice, when loading as workspace2D, re <a class="closed ticket" href="8172.html" title="task: Nexus file-loading clean-up (closed: fixed)">#8172</a>
</p>
<p>
Changeset: <a class="changeset" href="https://github.com/mantidproject/mantid/commit/0495042b9e8797897cd4dc03c02ee385b7fab125" title="0495042b9e8797897cd4dc03c02ee385b7fab125">0495042b9e8797897cd4dc03c02ee385b7fab125</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-7">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:7" class="cnum">
      <a href="8172.html#comment:7">comment:7</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-07T16%3A29%3A35Z&amp;precision=second" title="2015-01-07T16:29:35Z in Timeline">6 years</a> ago by Federico Montesino Pouzols
                </h3>
                
    <div class="comment searchable">
      
      <p>
more about not loading instrument twice, and comments, re <a class="closed ticket" href="8172.html" title="task: Nexus file-loading clean-up (closed: fixed)">#8172</a>
</p>
<p>
Changeset: <a class="changeset" href="https://github.com/mantidproject/mantid/commit/7a6112c60cd89008504304b811434016c11a2cfb" title="7a6112c60cd89008504304b811434016c11a2cfb">7a6112c60cd89008504304b811434016c11a2cfb</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-8">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:8" class="cnum">
      <a href="8172.html#comment:8">comment:8</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-07T16%3A29%3A35Z&amp;precision=second" title="2015-01-07T16:29:35Z in Timeline">6 years</a> ago by Federico Montesino Pouzols
                </h3>
                
    <div class="comment searchable">
      
      <p>
for now, least disruptive way to avoid loading logs twice, re <a class="closed ticket" href="8172.html" title="task: Nexus file-loading clean-up (closed: fixed)">#8172</a>
</p>
<p>
Changeset: <a class="changeset" href="https://github.com/mantidproject/mantid/commit/7d6b32e9bc1a97fc4feea58e86e83838ffce7b55" title="7d6b32e9bc1a97fc4feea58e86e83838ffce7b55">7d6b32e9bc1a97fc4feea58e86e83838ffce7b55</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-9">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:9" class="cnum">
      <a href="8172.html#comment:9">comment:9</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-07T16%3A45%3A24Z&amp;precision=second" title="2015-01-07T16:45:24Z in Timeline">6 years</a> ago by Federico M Pouzols
                </h3>
                
    <div class="comment searchable">
      
      <p>
Two issues were identified in this ticket (there are/may be more related issues, see <a class="inprogress ticket" href="10619.html" title="LoadEventNexus (+ LoadNexusMonitors and other LoadNexus...) ... (inprogress)">#10619</a>).
</p>
<ul><li>The first issue (logs and instrument are loaded twice in LoadEventNexus if you choose to load monitors) is fixed with the changes done so far in this ticket's branch.
</li></ul><ul><li>The second issue (nexus file is opened again if LoadIDFFromNexus is called as a child algorithm) I think could stay as it is for now, and it might be alleviated in further LoadXXXNexus maintenance work. See explanation below.
</li></ul><p>
In principle I would not worry much about the second issue for now. I would expect (and hope) that opening NeXus files is not expensive, because it is done many times for every file that is loaded.
</p>
<p>
In LoadEventNexus.cpp the nexus file is opened several times. In general, the file name is passed to all (helper) methods that need to read from the file, and the file is re-opened (sometimes in sequence, sometimes nested open calls):
</p>
<ul><li>in LoadBankFromDiskTask::run()
</li><li>in LoadEventNexus::setTopEntryName()
</li><li>in LoadEventNexus::loadEvents() to load the start_time if not loading logs 
</li><li>in LoadEventNexus::loadEvents() to load the instrument (loadInstrument() -&gt; runLoadIDFFromNexus())
</li><li>in LoadEventNexus::loadEvents() again, now to load the events
</li><li>in LoadEventNexus::loadEvents() -&gt; loadEntryMetadata()
</li><li>in LoadEventNexus::loadEvents() -&gt; createSpectraMapping() -&gt; loadSpectraMapping()
</li><li>in LoadEventNexus::loadEvents() -&gt; loadTimeOfFlight()
</li><li>in LoadEventNexus::hasEventMonitors()
</li></ul><p>
The file name is also passed as a property to child algorithms that open the nexus file again:
</p>
<ul><li>LoadNexusMonitors
</li><li>LoadNexusLogs
</li><li>LoadMonitors
</li><li>LoadIDFFromNexus
</li><li>LoadInstrument
</li></ul>
    </div>

              </div>
              <div class="change" id="trac-change-10">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:10" class="cnum">
      <a href="8172.html#comment:10">comment:10</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-21T18%3A15%3A00Z&amp;precision=second" title="2015-01-21T18:15:00Z in Timeline">6 years</a> ago by Federico Montesino Pouzols
                </h3>
                
    <div class="comment searchable">
      
      <p>
make sure to init m_allBanksPulseTimes irre logs are loaded, re <a class="closed ticket" href="8172.html" title="task: Nexus file-loading clean-up (closed: fixed)">#8172</a>
</p>
<p>
Changeset: <a class="changeset" href="https://github.com/mantidproject/mantid/commit/9c04c12ce39ba5dccdb691e74206beda0ec69147" title="9c04c12ce39ba5dccdb691e74206beda0ec69147">9c04c12ce39ba5dccdb691e74206beda0ec69147</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-11">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:11" class="cnum">
      <a href="8172.html#comment:11">comment:11</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-21T18%3A15%3A00Z&amp;precision=second" title="2015-01-21T18:15:00Z in Timeline">6 years</a> ago by Federico Montesino Pouzols
                </h3>
                
    <div class="comment searchable">
      
      <p>
this if breaks SysTests...LETReduction, investigate, re <a class="closed ticket" href="8172.html" title="task: Nexus file-loading clean-up (closed: fixed)">#8172</a>
</p>
<p>
Changeset: <a class="changeset" href="https://github.com/mantidproject/mantid/commit/01662d244c0fda0e568d585b13e0c6e6f8718874" title="01662d244c0fda0e568d585b13e0c6e6f8718874">01662d244c0fda0e568d585b13e0c6e6f8718874</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-12">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:12" class="cnum">
      <a href="8172.html#comment:12">comment:12</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-22T08%3A27%3A41Z&amp;precision=second" title="2015-01-22T08:27:41Z in Timeline">6 years</a> ago by Martyn Gigg
                </h3>
                
    <div class="comment searchable">
      
      <p>
Strangely the LETReduction test is now fixed on RHEL6 on incremental but not anywhere else - <a class="ext-link" href="http://builds.mantidproject.org/view/Develop%20Builds/job/develop_systemtests_all/"><span class="icon">​</span>http://builds.mantidproject.org/view/Develop%20Builds/job/develop_systemtests_all/</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-13">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:13" class="cnum">
      <a href="8172.html#comment:13">comment:13</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-23T11%3A58%3A43Z&amp;precision=second" title="2015-01-23T11:58:43Z in Timeline">6 years</a> ago by Federico M Pouzols
                </h3>
                
    <div class="comment searchable">
      
      <p>
The offending if statement was breaking SystemTests.ISISDirectInelastic.LETReduction loading of LET00006278.nxs fails with the following message (monitors not loaded):
</p>
<pre class="wiki">LoadEventNexus-[Error] Error while loading monitors as events from file: vector::_M_fill_insert
LoadEventNexus-[Notice] LoadEventNexus successful, Duration 6.48 seconds
</pre><p>
Which eventually produces this error in the <tt></tt><tt>AnalysisTests/ISIS_LETReduction.py</tt><tt></tt> system test script:
</p>
<pre class="wiki">ValueError: Invalid value for property InputWorkspace2 (MatrixWorkspace) "w1_monitors": Workspace "w1_monitors" was not found in the Analysis Data Service
</pre>
    </div>

              </div>
              <div class="change" id="trac-change-14">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:14" class="cnum">
      <a href="8172.html#comment:14">comment:14</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-23T16%3A44%3A24Z&amp;precision=second" title="2015-01-23T16:44:24Z in Timeline">6 years</a> ago by Federico Montesino Pouzols
                </h3>
                
    <div class="comment searchable">
      
      <p>
re-use instrument and logs for monitors workspace, re <a class="closed ticket" href="8172.html" title="task: Nexus file-loading clean-up (closed: fixed)">#8172</a>
</p>
<p>
Changeset: <a class="changeset" href="https://github.com/mantidproject/mantid/commit/7587f0af6e71513fc92db881a9da8925ae8b5714" title="7587f0af6e71513fc92db881a9da8925ae8b5714">7587f0af6e71513fc92db881a9da8925ae8b5714</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-15">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:15" class="cnum">
      <a href="8172.html#comment:15">comment:15</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-23T16%3A47%3A58Z&amp;precision=second" title="2015-01-23T16:47:58Z in Timeline">6 years</a> ago by Federico M Pouzols
                </h3>
                
    <div class="comment searchable">
      
      <p>
I think this last commit definitely fixes the issue, but I'm not merging into develop for now, until we get clean builds of the system tests.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-16">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:16" class="cnum">
      <a href="8172.html#comment:16">comment:16</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-26T13%3A01%3A21Z&amp;precision=second" title="2015-01-26T13:01:21Z in Timeline">6 years</a> ago by Federico M Pouzols
                </h3>
                
    <div class="comment searchable">
      
      <p>
Ok, now it's in develop and it seems that nothing has broken.
</p>
<p>
A simple 'benchmarking' with LET00006278.nxs shows that this change provides a not-that-bad speed-up.
With the following settings on: LoadMonitors, MonitorsAsEvents, LoadLogs I get the following times on Debian:
</p>
<p>
Once the filed is cached:
</p>
<ul><li>old LoadEventNexus (master): <strong>~4.70 s</strong> (between 4.68 and 4.73 for 10 repetitions)
</li><li>this branch: <strong>~3.97 s</strong> (between 3.95 and 3.99 for 10 repetitions) 
</li></ul><p>
First load:
</p>
<ul><li>old LoadEventNexus (master): <strong>9.88 s</strong>
</li><li>this branch: <strong>~9.20 s</strong>
</li></ul>
    </div>

                <div class="trac-lastedit ">
                  Last edited <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-26T13%3A01%3A40Z&amp;precision=second" title="2015-01-26T13:01:40Z in Timeline">6 years</a> ago
                      by Federico M Pouzols
                    (<a href="https://trac.mantidproject.org/mantid/ticket/8172?cversion=0&amp;cnum_hist=16#comment:16">previous</a>)
                    (<a href="https://trac.mantidproject.org/mantid/ticket/8172?action=comment-diff&amp;cnum=16&amp;version=1">diff</a>)
                </div>
              </div>
              <div class="change" id="trac-change-17">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:17" class="cnum">
      <a href="8172.html#comment:17">comment:17</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-27T14%3A54%3A17Z&amp;precision=second" title="2015-01-27T14:54:17Z in Timeline">6 years</a> ago by Federico Montesino Pouzols
                </h3>
                
    <div class="comment searchable">
      
      <p>
don't re-open the file, as far as possible for now, re <a class="closed ticket" href="8172.html" title="task: Nexus file-loading clean-up (closed: fixed)">#8172</a>
</p>
<p>
Changeset: <a class="changeset" href="https://github.com/mantidproject/mantid/commit/5fd6bc65a0183e5557e7bac4f1d7d56671cd7bc4" title="5fd6bc65a0183e5557e7bac4f1d7d56671cd7bc4">5fd6bc65a0183e5557e7bac4f1d7d56671cd7bc4</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-18">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:18" class="cnum">
      <a href="8172.html#comment:18">comment:18</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-27T16%3A02%3A56Z&amp;precision=second" title="2015-01-27T16:02:56Z in Timeline">6 years</a> ago by Federico M Pouzols
                </h3>
                
    <div class="comment searchable">
      
      <p>
In this last commit I tried to avoid re-opening the NeXus file. As listed in #<a href="8172.html#comment:9" title="Comment 9 for Ticket #8172">comment:9</a>, there's plenty of places where the file is being opened again without really needing it (it was generally
passed by name, and only in a few method as a reference to NeXus::File object. I added a m_file data member and re-used it as much as possible. There's three places where this was not possible though. The following four methods are static and called from other related algorithms:
</p>
<ul><li>LoadEventNexus::LoadEntryMetadata: used by LoadTOFRawNexus, LoadNexusMonitors
</li><li>LoadEventNexus::runLoadIDFFromNexus: used by LoadISISNexus2
</li><li>LoadEventNexus::runLoadInstrument: used by LoadTOFRawNexus, LoadPreNexus
</li><li>LoadEventNexus::runLoadNexusLogs: used by LoadTOFRawNexus
</li></ul><p>
This new ticket has been created to clarify this: <a class="assigned ticket" href="10975.html" title="Clarify issues with static methods in LoadEventNexus being used by other ... (assigned)">#10975</a>.
</p>
<p>
This means that a file re-open has been avoided in: setTopEntryName, inside loadEvents (2 or 3 times depending on whether monitors are loaded as events), hasEventMonitors, loadSpectraMapping, and loadtimeOfFlight.
</p>
<p>
Style note: in 3 methods, a few calls like <tt></tt><tt>file.openGroup(...)</tt><tt></tt> have been modified to <tt></tt><tt>m_file-&gt;openGroup(...)</tt><tt></tt>
Alternatively we could use a reference at the beginning of the methods to keep those lines unmodified. I opted for making the use of the m_file data member more explicit everywhere.
</p>
<p>
As I'd expect this modification had only marginal performance effects.
</p>
<ul><li>Run time of first load: seems to go down from <strong>~9.20</strong> to <strong>~9.11</strong>
</li><li>Run time of subsequent loads: virtually same values for 10 repetitions.
</li></ul>
    </div>

              </div>
              <div class="change" id="trac-change-19">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:19" class="cnum">
      <a href="8172.html#comment:19">comment:19</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-30T08%3A41%3A55Z&amp;precision=second" title="2015-01-30T08:41:55Z in Timeline">6 years</a> ago by Federico M Pouzols
                </h3>
                
    <div class="comment searchable">
      
      <p>
It seems to be working well. Steps to test:
</p>
<ul><li>Double-check unit tests and system tests (especially with '-R Nexus', '-R ISIS'.
</li><li>Review code. For an explanation of what was done, please check #<a href="8172.html#comment:9" title="Comment 9 for Ticket #8172">comment:9</a>, but note that in the end the  multiple file open operations were cut down, as explained in #<a href="8172.html#comment:18" title="Comment 18 for Ticket #8172">comment:18</a>.
</li><li>In performance tests, if any, this should produce an improvement.
</li></ul><p>
This ticket is related to a few other ones that are in the 'blocking' list of <a class="inprogress ticket" href="10619.html" title="LoadEventNexus (+ LoadNexusMonitors and other LoadNexus...) ... (inprogress)">#10619</a>.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-20">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:20" class="cnum">
      <a href="8172.html#comment:20">comment:20</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-30T08%3A42%3A02Z&amp;precision=second" title="2015-01-30T08:42:02Z in Timeline">6 years</a> ago by Federico M Pouzols
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>inprogress</em> to <em>verify</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>fixed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-21">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:21" class="cnum">
      <a href="8172.html#comment:21">comment:21</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-30T13%3A22%3A22Z&amp;precision=second" title="2015-01-30T13:22:22Z in Timeline">6 years</a> ago by Harry Jeffery
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>verify</em> to <em>verifying</em>
    </li><li>
      <strong>Tester</strong>
        set to <em>Harry Jeffery</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-22">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:22" class="cnum">
      <a href="8172.html#comment:22">comment:22</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-01-30T14%3A41%3A00Z&amp;precision=second" title="2015-01-30T14:41:00Z in Timeline">6 years</a> ago by Harry Jeffery
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>verifying</em> to <em>closed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Merge remote-tracking branch 'origin/bugfix/8172_nexus_file_loading_clean_up'
</p>
<p>
Full changeset: <a class="ext-link" href="https://github.com/mantidproject/mantid/commit/2b9929870432c6cf51a54ea63213e98f2e16aeca"><span class="icon">​</span>2b9929870432c6cf51a54ea63213e98f2e16aeca</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-23">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:23" class="cnum">
      <a href="8172.html#comment:23">comment:23</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-02-06T13%3A00%3A00Z&amp;precision=second" title="2015-02-06T13:00:00Z in Timeline">6 years</a> ago by Federico M Pouzols
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Keywords</strong>
        <em>Maintenance,</em> <em>CORE</em> added; <em>Maintenance</em> removed
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Added CORE keyword as suggested by Anders.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-24">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:24" class="cnum">
      <a href="8172.html#comment:24">comment:24</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-02-06T20%3A49%3A55Z&amp;precision=second" title="2015-02-06T20:49:55Z in Timeline">6 years</a> ago by Harry Jeffery
                </h3>
                
    <div class="comment searchable">
      
      <p>
Merge remote-tracking branch 'origin/bugfix/8172_nexus_file_loading_clean_up'
</p>
<p>
Full changeset: <a class="ext-link" href="https://github.com/mantidproject/mantid/commit/2b9929870432c6cf51a54ea63213e98f2e16aeca"><span class="icon">​</span>2b9929870432c6cf51a54ea63213e98f2e16aeca</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-25">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:25" class="cnum">
      <a href="8172.html#comment:25">comment:25</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-04-22T10%3A21%3A42%2B01%3A00&amp;precision=second" title="2015-04-22T10:21:42+01:00 in Timeline">5 years</a> ago by Nick Draper
                </h3>
                
    <div class="comment searchable">
      
      <p>
Somehow these slipped through without a resolution.  Set to Fixed.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-26">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:26" class="cnum">
      <a href="8172.html#comment:26">comment:26</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-06-04T02%3A25%3A44%2B01%3A00&amp;precision=second" title="2015-06-04T02:25:44+01:00 in Timeline">5 years</a> ago by Stuart Campbell
                </h3>
                
    <div class="comment searchable">
      
      <p>
This ticket has been transferred to github issue <a class="ext-link" href="http://github.com/mantidproject/mantid/issues/9017"><span class="icon">​</span>9017</a>
</p>

    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="../wiki/TracTickets.html">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/8172?format=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/8172?format=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/8172?format=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="../about.html"><strong>Trac 0.12.5</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the Trac open source project at<br /><a href="http://trac.edgewall.org/">http://trac.edgewall.org/</a></p>
    </div>
  </body>
</html>