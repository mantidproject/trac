<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  


  <head>
    <title>
      #9419 (Replacing a workspace &amp; instrument view exception)
     – Mantid Project
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
        <link rel="search" href="../search.html" />
        <link rel="prev" href="9418.html" title="Ticket #9418" />
        <link rel="last" href="11888.html" title="Ticket #11888" />
        <link rel="help" href="../wiki/TracGuide.html" />
        <link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/9419?format=csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/9419?format=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="https://trac.mantidproject.org/mantid/ticket/9419?format=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="next" href="9420.html" title="Ticket #9420" />
        <link rel="start" href="../wiki.html" />
        <link rel="stylesheet" href="../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../chrome/common/css/ticket.css" type="text/css" />
        <link rel="first" href="1.html" title="Ticket #1" />
        <link rel="shortcut icon" href="../chrome/common/trac.ico" type="image/x-icon" />
        <link rel="icon" href="../chrome/common/trac.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="../search/opensearch" title="Search Mantid Project" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="a82fe30e7bef2e30fd2838e9";
    </script>
    <script type="text/javascript" src="../chrome/common/js/jquery.js"></script><script type="text/javascript" src="../chrome/common/js/babel.js"></script><script type="text/javascript" src="../chrome/common/js/messages/en_US.js"></script><script type="text/javascript" src="../chrome/common/js/trac.js"></script><script type="text/javascript" src="../chrome/common/js/search.js"></script><script type="text/javascript" src="../chrome/common/js/folding.js"></script><script type="text/javascript" src="../chrome/common/js/wikitoolbar.js"></script><script type="text/javascript" src="../chrome/common/js/resizer.js"></script><script type="text/javascript" src="../chrome/common/js/auto_preview.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/mantid/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
        var args = {realm: "ticket", id: 9419, escape_newlines: 0}
        $("#comment").autoPreview("/mantid/wiki_render", args, function(textarea, text, rendered) {
            $("#ticketchange div.comment").html(rendered);
            if (rendered)
              $("#ticketchange").show();
            else if ($("#ticketchange ul.changes").length == 0)
              $("#ticketchange").hide();
        });
        $("#trac-comment-editor textarea").autoPreview("/mantid/wiki_render", args,
                                                       function(textarea, text, rendered) {
          var comment = $("#trac-comment-editor").next("div.comment");
          comment.html(rendered);
          if (rendered)
            comment.show();
          else
            comment.hide();
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
      });
    </script>
    <link rel="stylesheet" type="text/css" href="../chrome/site/style.css" />
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="http://www.mantidproject.org/"><img src="../chrome/site/mantid_logo_with_name.png" alt="Mantid Logo" width="250" /></a>
      </div>
      <form id="search" action="../search.html" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="https://trac.mantidproject.org/mantid/login">Login</a></li><li><a href="../prefs.html">Preferences</a></li><li><a href="../wiki/TracGuide.html">Help/Guide</a></li><li class="last"><a href="../about.html">About Trac</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first"><a href="../wiki.html">Wiki</a></li><li><a href="../timeline.html">Timeline</a></li><li><a href="../roadmap.html">Roadmap</a></li><li class="active"><a href="../report.html">View Tickets</a></li><li class="last"><a href="../search.html">Search</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
          <ul>
              <li class="first"><span>&larr; <a class="prev" href="9418.html" title="Ticket #9418">Previous Ticket</a></span></li><li class="last"><span><a class="next" href="9420.html" title="Ticket #9420">Next Ticket</a> &rarr;</span></li>
          </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="9419.html">Ticket #9419</a>
          <span class="status">(closed: fixed)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-05-06T17%3A55%3A23%2B01%3A00&amp;precision=second" title="2014-05-06T17:55:23+01:00 in Timeline">6 years</a> ago</p>
    <p>Last modified <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-06-04T03%3A17%3A25%2B01%3A00&amp;precision=second" title="2015-06-04T03:17:25+01:00 in Timeline">5 years</a> ago</p>
  </div>
  <h2 class="summary searchable">Replacing a workspace &amp; instrument view exception</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;reporter=Russell+Taylor">Russell Taylor</a>
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;owner=Russell+Taylor">Russell Taylor</a>
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;priority=critical">critical</a>
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="closed milestone" href="../milestone/Release&#32;3.2.html">Release 3.2</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="https://trac.mantidproject.org/mantid/query?status=!closed&amp;component=GUI">GUI</a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
        <th id="h_blockedby">
          Blocked By:
        </th>
        <td headers="h_blockedby"><span></span></td>
    </tr><tr>
        <th id="h_blocking">
          Blocking:
        </th>
        <td headers="h_blocking"><span></span></td>
        <th id="h_tester">
          Tester:
        </th>
        <td headers="h_tester">
              Peter Parker
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
Ross Miller wrote:
</p>
<blockquote>
<p>
I noticed what I think is a bug in MantidPlot: If you start up the live listener in either ‘Rename’ or ‘Restart’ mode, and then view the output workspace in the instrument view, everything is fine until the next run transition.  At that point, you get an unhandled exception from the instrument view and the dialog says the workspace doesn’t exist.
</p>
</blockquote>
<blockquote>
<p>
I’m guessing this is because at the run transitions, we either delete or rename the original workspace and then create a new one that has the same name.  I assume the instrument view just sees its pointer to the workspace go invalid.
</p>
</blockquote>
<p>
I expect this is because the rename notification is not going out/getting picked up.
</p>

    </div>
  </div>
</div>
          

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="9419.html#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-05-06T17%3A55%3A29%2B01%3A00&amp;precision=second" title="2014-05-06T17:55:29+01:00 in Timeline">6 years</a> ago by Russell Taylor
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>assigned</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="9419.html#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-05-20T18%3A52%3A41%2B01%3A00&amp;precision=second" title="2014-05-20T18:52:41+01:00 in Timeline">6 years</a> ago by Russell Taylor
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Summary</strong>
        changed from <em>Live listener &amp; instrument view exception</em> to <em>Replacing a workspace &amp; instrument view exception</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
This is nothing specific to live data - it happens as well if you load a file, show the instrument and then reload that file into a workspace with the same name. So I've updated the title.
</p>
<p>
The stack trace that leads to the exception is:
</p>
<pre class="wiki">InstrumentActor::getWorkspace() at InstrumentActor.cpp:220             
InstrumentActor::setDataIntegrationRange() at InstrumentActor.cpp:1,069     
InstrumentActor::setIntegrationRange() at InstrumentActor.cpp:374 
InstrumentActor::updateColors() at InstrumentActor.cpp:634                
InstrumentWindow::afterReplaceHandle() at InstrumentWindow.cpp:730 
</pre><p>
       
In InstrumentWindow::afterReplaceHandle() the code is making a call into InstrumentActor that ultimately requires the workspace, though the workspace has changed and the pointer has not been updated. 
</p>

    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="9419.html#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-05-20T22%3A27%3A43%2B01%3A00&amp;precision=second" title="2014-05-20T22:27:43+01:00 in Timeline">6 years</a> ago by Russell Taylor
                </h3>
                
    <div class="comment searchable">
      
      <p>
This bug was introduced in <a class="ext-link" href="https://github.com/mantidproject/mantid/commit/a71aef8ebc93714d500d0ead74fcac856a0b43e3#diff-2"><span class="icon">​</span>https://github.com/mantidproject/mantid/commit/a71aef8ebc93714d500d0ead74fcac856a0b43e3#diff-2</a> under <a class="closed ticket" href="8569.html" title="enhancement: Add option to cylindrical and spherical views to set the starting point in ... (closed: fixed)">#8569</a>. The commit message says that it's just a code cleaning refactoring, but it clearly did more than that as it changed behaviour (from creating a new InstrumentActor object to attempting to update the existing one).
</p>

    </div>

              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="9419.html#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-05-22T20%3A40%3A55%2B01%3A00&amp;precision=second" title="2014-05-22T20:40:55+01:00 in Timeline">6 years</a> ago by Russell Taylor
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>assigned</em> to <em>inprogress</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Re <a class="closed ticket" href="9419.html" title="defect: Replacing a workspace &amp; instrument view exception (closed: fixed)">#9419</a>. Remove no-op statement.
</p>
<p>
The getWorkspace method will throw if the workspace is going to be null
so this line is pointless.
</p>
<p>
Changeset: <a class="changeset" href="https://github.com/mantidproject/mantid/commit/caae3a81e1b779ec3bfd68be79f2126377a94b56" title="caae3a81e1b779ec3bfd68be79f2126377a94b56">caae3a81e1b779ec3bfd68be79f2126377a94b56</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-5">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:5" class="cnum">
      <a href="9419.html#comment:5">comment:5</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-05-22T20%3A40%3A55%2B01%3A00&amp;precision=second" title="2014-05-22T20:40:55+01:00 in Timeline">6 years</a> ago by Russell Taylor
                </h3>
                
    <div class="comment searchable">
      
      <p>
Re <a class="closed ticket" href="9419.html" title="defect: Replacing a workspace &amp; instrument view exception (closed: fixed)">#9419</a>. Consolidate code that uses the workspace pointer.
</p>
<p>
Changeset: <a class="changeset" href="https://github.com/mantidproject/mantid/commit/7ae5e42f33e20b9d7876d8eb7877b8b588ee1074" title="7ae5e42f33e20b9d7876d8eb7877b8b588ee1074">7ae5e42f33e20b9d7876d8eb7877b8b588ee1074</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-6">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:6" class="cnum">
      <a href="9419.html#comment:6">comment:6</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-05-22T20%3A40%3A55%2B01%3A00&amp;precision=second" title="2014-05-22T20:40:55+01:00 in Timeline">6 years</a> ago by Russell Taylor
                </h3>
                
    <div class="comment searchable">
      
      <p>
Re <a class="closed ticket" href="9419.html" title="defect: Replacing a workspace &amp; instrument view exception (closed: fixed)">#9419</a>. Check whether workspace is actually the same one.
</p>
<p>
The code before was OK if the 'new' workspace was actually still the
same one, but led to an exception if it was a different workspace just
having the same name. In the latter case we need to recreate the
InstrumentActor (as the code always did in the past).
</p>
<p>
Changeset: <a class="changeset" href="https://github.com/mantidproject/mantid/commit/53fdf98d105a780ab196e366e81efc8a7cfbf331" title="53fdf98d105a780ab196e366e81efc8a7cfbf331">53fdf98d105a780ab196e366e81efc8a7cfbf331</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-7">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:7" class="cnum">
      <a href="9419.html#comment:7">comment:7</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-05-22T21%3A42%3A59%2B01%3A00&amp;precision=second" title="2014-05-22T21:42:59+01:00 in Timeline">6 years</a> ago by Russell Taylor
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>inprogress</em> to <em>verify</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>fixed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
The problem is now solved by checking whether the workspace being replaced is actually still the same workspace or not (it would be for, e.g., a ConvertUnits into the same output workspace). Things were OK if it was still the same workspace, but if not the exception turned up. This was the case for the live data example given in the description and if you load over a displayed workspace. Another example would be rebinning an event workspace but not preserving events.
</p>
<p>
Test by having a play with the Instrument Window. Make sure you can reproduce the issue before  applying the fix and that it's gone afterwards. Check that things are OK in some other situations where a displayed workspace is being updated.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-8">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:8" class="cnum">
      <a href="9419.html#comment:8">comment:8</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-05-30T14%3A57%3A05%2B01%3A00&amp;precision=second" title="2014-05-30T14:57:05+01:00 in Timeline">6 years</a> ago by Peter Parker
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>verify</em> to <em>verifying</em>
    </li><li>
      <strong>Tester</strong>
        set to <em>Peter Parker</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-9">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:9" class="cnum">
      <a href="9419.html#comment:9">comment:9</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-05-30T15%3A57%3A17%2B01%3A00&amp;precision=second" title="2014-05-30T15:57:17+01:00 in Timeline">6 years</a> ago by Peter Parker
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>verifying</em> to <em>closed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Merge remote-tracking branch 'origin/bugfix/9419_instrumentview_exception_on_replace'
</p>
<p>
Full changeset: <a class="ext-link" href="https://github.com/mantidproject/mantid/commit/1e75114eb7f95ed609ef4942ce747919a0766a48"><span class="icon">​</span>1e75114eb7f95ed609ef4942ce747919a0766a48</a>
</p>

    </div>

              </div>
              <div class="change" id="trac-change-10">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:10" class="cnum">
      <a href="9419.html#comment:10">comment:10</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-05-30T16%3A02%3A07%2B01%3A00&amp;precision=second" title="2014-05-30T16:02:07+01:00 in Timeline">6 years</a> ago by Peter Parker
                </h3>
                
    <div class="comment searchable">
      
      <p>
Could reproduce the problem with the following:
</p>
<pre class="wiki">ws = Load("IRS21360.raw")
inst_win = getInstrumentView("ws")
inst_win.show()
ws = Load("IRS21360.raw")
</pre><p>
The script ran fine once I merged in the branch.
</p>
<p>
We'd also been seeing crashes when doing multiple reductions in the ISIS SANS interface with the Instrument View open.  These seem to have been cleared up as well.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-11">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:11" class="cnum">
      <a href="9419.html#comment:11">comment:11</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-05-30T16%3A05%3A08%2B01%3A00&amp;precision=second" title="2014-05-30T16:05:08+01:00 in Timeline">6 years</a> ago by Peter Parker
                </h3>
                
    <div class="comment searchable">
      
      <p>
@Russell - I take it the scope of the MantidPlotInstrumentViewTest.py file is limited enough so that this edge case was not considered a reasonable thing to test?  Or is the double loading of a file that would put us off here?
</p>

    </div>

              </div>
              <div class="change" id="trac-change-12">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:12" class="cnum">
      <a href="9419.html#comment:12">comment:12</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2014-05-30T17%3A17%3A06%2B01%3A00&amp;precision=second" title="2014-05-30T17:17:06+01:00 in Timeline">6 years</a> ago by Russell Taylor
                </h3>
                
    <div class="comment searchable">
      
      <p>
Truth be told I didn't think about there being a test for this, as there usually isn't for MantidPlot. I suppose it could be tested, though the failure case before the fix would presumably have been the test getting stuck which isn't great.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-13">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:13" class="cnum">
      <a href="9419.html#comment:13">comment:13</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="https://trac.mantidproject.org/mantid/timeline?from=2015-06-04T03%3A17%3A25%2B01%3A00&amp;precision=second" title="2015-06-04T03:17:25+01:00 in Timeline">5 years</a> ago by Stuart Campbell
                </h3>
                
    <div class="comment searchable">
      
      <p>
This ticket has been transferred to github issue <a class="ext-link" href="http://github.com/mantidproject/mantid/issues/10262"><span class="icon">​</span>10262</a>
</p>

    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="../wiki/TracTickets.html">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/9419?format=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/9419?format=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="https://trac.mantidproject.org/mantid/ticket/9419?format=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="../about.html"><strong>Trac 0.12.5</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the Trac open source project at<br /><a href="http://trac.edgewall.org/">http://trac.edgewall.org/</a></p>
    </div>
  </body>
</html>